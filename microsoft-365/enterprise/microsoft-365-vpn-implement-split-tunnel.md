---
title: 实现 Office 365 的 VPN 拆分隧道
ms.author: kvice
author: kelleyvice-msft
manager: laurawi
ms.date: 9/22/2020
audience: Admin
ms.topic: conceptual
ms.service: o365-administration
localization_priority: Normal
search.appverid:
- MET150
ms.collection:
- Ent_O365
- Strat_O365_Enterprise
- remotework
f1.keywords:
- NOCSH
description: 如何实现 Office 365 的 VPN 拆分隧道
ms.openlocfilehash: 49d64a40a39a6f8b1f8ea585b2915c26bd1115c6
ms.sourcegitcommit: 05f40904f8278f53643efa76a907968b5c662d9a
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/30/2021
ms.locfileid: "52114232"
---
# <a name="implementing-vpn-split-tunneling-for-office-365"></a><span data-ttu-id="64cd6-103">实现 Office 365 的 VPN 拆分隧道</span><span class="sxs-lookup"><span data-stu-id="64cd6-103">Implementing VPN split tunneling for Office 365</span></span>

>[!NOTE]
><span data-ttu-id="64cd6-104">本主题是一组针对远程用户的 Office 365 优化的主题的一部分。</span><span class="sxs-lookup"><span data-stu-id="64cd6-104">This topic is part of a set of topics that address Office 365 optimization for remote users.</span></span>
>- <span data-ttu-id="64cd6-105">有关使用 VPN 拆分隧道为远程用户优化 Office 365 连接的概述，请参阅[概述： Office 365 的 VPN 拆分隧道](microsoft-365-vpn-split-tunnel.md)。</span><span class="sxs-lookup"><span data-stu-id="64cd6-105">For an overview of using VPN split tunneling to optimize Office 365 connectivity for remote users, see [Overview: VPN split tunneling for Office 365](microsoft-365-vpn-split-tunnel.md).</span></span>
>- <span data-ttu-id="64cd6-106">有关为中国用户优化 Office 365 全球租户性能的详细信息，请参阅[面向中国用户的 Office 365 性能优化](microsoft-365-networking-china.md)。</span><span class="sxs-lookup"><span data-stu-id="64cd6-106">For information about optimizing Office 365 worldwide tenant performance for users in China, see [Office 365 performance optimization for China users](microsoft-365-networking-china.md).</span></span>

<span data-ttu-id="64cd6-107">多年来，企业一直使用 VPN 来支持其用户的远程体验。</span><span class="sxs-lookup"><span data-stu-id="64cd6-107">For many years, enterprises have been using VPNs to support remote experiences for their users.</span></span> <span data-ttu-id="64cd6-108">虽然核心工作负载保持在本地，但通过公司网络上的数据中心路由的远程客户端的 VPN 是供远程用户访问公司资源的主要方法。</span><span class="sxs-lookup"><span data-stu-id="64cd6-108">Whilst core workloads remained on-premises, a VPN from the remote client routed through a datacenter on the corporate network was the primary method for remote users to access corporate resources.</span></span> <span data-ttu-id="64cd6-109">为保证这些连接的安全性，企业将沿 VPN 路径构建网络安全解决方案层。</span><span class="sxs-lookup"><span data-stu-id="64cd6-109">To safeguard these connections, enterprises build layers of network security solutions along the VPN paths.</span></span> <span data-ttu-id="64cd6-110">构建此安全是为了保护内部基础结构，并通过将流量重新路由到 VPN，然后通过本地 Internet 外围来保护外部网站的移动浏览。</span><span class="sxs-lookup"><span data-stu-id="64cd6-110">This security was built to protect internal infrastructure and to safeguard mobile browsing of external web sites by rerouting traffic into the VPN and then out through the on-premises Internet perimeter.</span></span> <span data-ttu-id="64cd6-111">VPN、网络外围和相关的安全基础结构通常是针对定义的流量进行特意构建和扩展的，通常大多数连接都是从企业网络内部启动的，并且大部分连接都位于内部网络边界之内。</span><span class="sxs-lookup"><span data-stu-id="64cd6-111">VPNs, network perimeters, and associated security infrastructure were often purpose-built and scaled for a defined volume of traffic, typically with most connectivity being initiated from within the corporate network, and most of it staying within the internal network boundaries.</span></span>

<span data-ttu-id="64cd6-112">在相当长的一段时间内，只要远程用户的并发规模适中且遍历 VPN 的流量较低，那么所有来自远程用户设备的连接都被路由回本地网络的 VPN 模型（这称为 **强制隧道**）基本上是可持续的。</span><span class="sxs-lookup"><span data-stu-id="64cd6-112">For quite some time, VPN models where all connections from the remote user device are routed back into the on-premises network (known as **forced tunneling**) were largely sustainable as long as the concurrent scale of remote users was modest and the traffic volumes traversing VPN were low.</span></span>  <span data-ttu-id="64cd6-113">一些客户甚至在他们的应用从企业外围转移到公共 SaaS 云之后，仍继续将 VPN 强制隧道用作现状， Office 365 就是一个很好的例子。</span><span class="sxs-lookup"><span data-stu-id="64cd6-113">Some customers continued to use VPN force tunneling as the status quo even after their applications moved from inside the corporate perimeter to public SaaS clouds, Office 365 being a prime example.</span></span>

<span data-ttu-id="64cd6-114">使用强制隧道 VPN 连接到分布式和性能敏感的云应用程序是非优化的，但一些企业为了从安全角度维持状态而接受其负面影响。</span><span class="sxs-lookup"><span data-stu-id="64cd6-114">The use of forced tunneled VPNs for connecting to distributed and performance-sensitive cloud applications is suboptimal, but the negative effect of that may have been accepted by some enterprises so as to maintain the status quo from a security perspective.</span></span> <span data-ttu-id="64cd6-115">下面是此场景的一个示例图：</span><span class="sxs-lookup"><span data-stu-id="64cd6-115">An example diagram of this scenario can be seen below:</span></span>

![拆分隧道 VPN 配置](../media/vpn-split-tunneling/enterprise-network-traditional.png)

<span data-ttu-id="64cd6-117">此问题多年来一直在增长，许多客户报告网络流量模式发生显著变化。</span><span class="sxs-lookup"><span data-stu-id="64cd6-117">This problem has been growing for many years, with many customers reporting a significant shift of network traffic patterns.</span></span> <span data-ttu-id="64cd6-118">过去位于本地的流量现在连接到外部云终结点。</span><span class="sxs-lookup"><span data-stu-id="64cd6-118">Traffic that used to stay on premises now connects to external cloud endpoints.</span></span> <span data-ttu-id="64cd6-119">许多 Microsoft 客户报告，以前大约 80% 的网络流量都来自内部（上图中用虚线表示）。</span><span class="sxs-lookup"><span data-stu-id="64cd6-119">Numerous Microsoft customers report that previously, around 80% of their network traffic was to some internal source (represented by the dotted line in the above diagram).</span></span> <span data-ttu-id="64cd6-120">到 2020 年，随着他们将主要的工作负载转移到云上，这一数字现在约为 20% 或更低，这些趋势在其他企业中并不罕见。</span><span class="sxs-lookup"><span data-stu-id="64cd6-120">In 2020 that number is now around 20% or lower as they have shifted major workloads to the cloud, these trends are not uncommon with other enterprises.</span></span> <span data-ttu-id="64cd6-121">随着时间的推移和云历程的发展，上述模型变得愈加累赘且不可持续，这使得组织在迁移到以云为中心的世界时的敏捷度受到影响。</span><span class="sxs-lookup"><span data-stu-id="64cd6-121">Over time, as the cloud journey progresses, the above model becomes increasingly cumbersome and unsustainable, preventing an organization from being agile as they move into a cloud first world.</span></span>

<span data-ttu-id="64cd6-122">全球 COVID-19 危机升级了此问题，需要立即修正。</span><span class="sxs-lookup"><span data-stu-id="64cd6-122">The worldwide COVID-19 crisis has escalated this problem to require immediate remediation.</span></span> <span data-ttu-id="64cd6-123">确保员工安全的需要对企业 IT 部门提出了前所未有的要求，要求他们支持大规模在家办公的工作效率。</span><span class="sxs-lookup"><span data-stu-id="64cd6-123">The need to ensure employee safety has generated unprecedented demands on enterprise IT to support work-from-home productivity at a massive scale.</span></span> <span data-ttu-id="64cd6-124">Microsoft Office 365可以帮助客户满足该需求，但在家工作的用户的高并发性会产生大量 Office 365 流量，如果通过强制隧道 VPN 和本地网络外围进行路由，则会导致快速饱和并运行容量不足的 VPN 基础结构。</span><span class="sxs-lookup"><span data-stu-id="64cd6-124">Microsoft Office 365 is well positioned to help customers fulfill that demand, but high concurrency of users working from home generates a large volume of Office 365 traffic which, if routed through forced tunnel VPN and on-premises network perimeters, causes rapid saturation and runs VPN infrastructure out of capacity.</span></span> <span data-ttu-id="64cd6-125">在此新现实中，使用 VPN 访问 Office 365 不再是性能障碍，而是一个不仅影响 Office 365 而且仍必须依赖 VPN 才能运行的关键业务运营的硬墙。</span><span class="sxs-lookup"><span data-stu-id="64cd6-125">In this new reality, using VPN to access Office 365 is no longer just a performance impediment, but a hard wall that not only impacts Office 365 but critical business operations that still have to rely on the VPN to operate.</span></span>

<span data-ttu-id="64cd6-126">多年来，Microsoft 一直与客户和更广泛的行业紧密协作，从我们自己的服务中为这些问题提供有效的新式解决方案，并与行业最佳做法保持一致。</span><span class="sxs-lookup"><span data-stu-id="64cd6-126">Microsoft has been working closely with customers and the wider industry for many years to provide effective, modern solutions to these problems from within our own services, and to align with industry best practice.</span></span> <span data-ttu-id="64cd6-127">Office 365 服务的[连接原则](./microsoft-365-network-connectivity-principles.md)旨在高效地为远程用户工作，同时仍允许组织保持安全性并控制其连接。</span><span class="sxs-lookup"><span data-stu-id="64cd6-127">[Connectivity principles](./microsoft-365-network-connectivity-principles.md) for the Office 365 service have been designed to work efficiently for remote users whilst still allowing an organization to maintain security and control over their connectivity.</span></span> <span data-ttu-id="64cd6-128">这些解决方案也可在有限的工作下快速实施，但是对上述问题产生显著正面影响。</span><span class="sxs-lookup"><span data-stu-id="64cd6-128">These solutions can also be implemented quickly with limited work yet achieve a significant positive impact on the problems outlined above.</span></span>

<span data-ttu-id="64cd6-129">Microsoft 建议的优化远程工作者连接策略主要是通过几个简单的步骤快速缓解传统方法的问题，并提供高性能。</span><span class="sxs-lookup"><span data-stu-id="64cd6-129">Microsoft's recommended strategy for optimizing remote worker's connectivity is focused on rapidly alleviating the problems with the traditional approach and also providing high performance with a few simple steps.</span></span> <span data-ttu-id="64cd6-130">这些步骤为绕过瓶颈 VPN 服务器的一些已定义终结点调整旧 VPN 方法。</span><span class="sxs-lookup"><span data-stu-id="64cd6-130">These steps adjust the legacy VPN approach for a few defined endpoints that bypass bottlenecked VPN servers.</span></span> <span data-ttu-id="64cd6-131">可在不同的层应用等效的或甚至是更高级的安全模型，而无需在公司网络出口保护所有流量。</span><span class="sxs-lookup"><span data-stu-id="64cd6-131">An equivalent or even superior security model can be applied at different layers to remove the need to secure all traffic at the egress of the corporate network.</span></span> <span data-ttu-id="64cd6-132">在大多数情况下，可以在数小时内有效实现此功能，然后可根据需要以及时间允许的情况下扩展到其他工作负载。</span><span class="sxs-lookup"><span data-stu-id="64cd6-132">In most cases this can be effectively achieved within hours and is then scalable to other workloads as requirements demand and time allows.</span></span>

## <a name="common-vpn-scenarios"></a><span data-ttu-id="64cd6-133">常见 VPN 方案</span><span class="sxs-lookup"><span data-stu-id="64cd6-133">Common VPN scenarios</span></span>

<span data-ttu-id="64cd6-134">在下面的列表中，你将看到企业环境中最常见的 VPN 方案。</span><span class="sxs-lookup"><span data-stu-id="64cd6-134">In the list below you'll see the most common VPN scenarios seen in enterprise environments.</span></span> <span data-ttu-id="64cd6-135">大多数客户通常运行模型 1（VPN 强制隧道）。</span><span class="sxs-lookup"><span data-stu-id="64cd6-135">Most customers traditionally operate model 1 (VPN Forced Tunnel).</span></span> <span data-ttu-id="64cd6-136">本节将帮助您快速、安全地过渡到模型 **2，** 这可以通过相对少的工作实现，并且对网络性能和用户体验具有巨大优势。</span><span class="sxs-lookup"><span data-stu-id="64cd6-136">This section will help you to quickly and securely transition to **model 2**, which is achievable with relatively little effort, and has enormous benefits to network performance and user experience.</span></span>

| <span data-ttu-id="64cd6-137">模型</span><span class="sxs-lookup"><span data-stu-id="64cd6-137">Model</span></span> | <span data-ttu-id="64cd6-138">说明</span><span class="sxs-lookup"><span data-stu-id="64cd6-138">Description</span></span> |
| --- | --- |
| [<span data-ttu-id="64cd6-139">1. VPN 强制隧道</span><span class="sxs-lookup"><span data-stu-id="64cd6-139">1. VPN Forced Tunnel</span></span>](#1-vpn-forced-tunnel) | <span data-ttu-id="64cd6-140">100% 的流量进入 VPN 隧道，包括本地、Internet 以及所有 O365/M365</span><span class="sxs-lookup"><span data-stu-id="64cd6-140">100% of traffic goes into VPN tunnel, including on-premise, Internet, and all O365/M365</span></span> |
| [<span data-ttu-id="64cd6-141">2. VPN 强制隧道（有几个例外）</span><span class="sxs-lookup"><span data-stu-id="64cd6-141">2. VPN Forced Tunnel with few exceptions</span></span>](#2-vpn-forced-tunnel-with-a-small-number-of-trusted-exceptions) | <span data-ttu-id="64cd6-142">默认情况下使用 VPN 隧道（默认路由指向 VPN），有几个最重要的豁免场景允许直接访问</span><span class="sxs-lookup"><span data-stu-id="64cd6-142">VPN tunnel is used by default (default route points to VPN), with few, most important exempt scenarios that are allowed to go direct</span></span> |
| [<span data-ttu-id="64cd6-143">3. VPN 强制隧道（有多个例外）</span><span class="sxs-lookup"><span data-stu-id="64cd6-143">3. VPN Forced Tunnel with broad exceptions</span></span>](#3-vpn-forced-tunnel-with-broad-exceptions) | <span data-ttu-id="64cd6-144">默认情况下使用 VPN 隧道（默认路由指向 VPN），有多个允许直接访问的例外情况（如所有 Office 365、所有 Salesforce、所有 Zoom）</span><span class="sxs-lookup"><span data-stu-id="64cd6-144">VPN tunnel is used by default (default route points to VPN), with broad exceptions that are allowed to go direct (such as all Office 365, All Salesforce, All Zoom)</span></span> |
| [<span data-ttu-id="64cd6-145">4. VPN 选择性隧道</span><span class="sxs-lookup"><span data-stu-id="64cd6-145">4. VPN Selective Tunnel</span></span>](#4-vpn-selective-tunnel) | <span data-ttu-id="64cd6-146">VPN 隧道仅用于基于公司网络的服务。</span><span class="sxs-lookup"><span data-stu-id="64cd6-146">VPN tunnel is used only for corpnet-based services.</span></span> <span data-ttu-id="64cd6-147">默认路由 (Internet，所有基于 Internet 的服务) 直接路由。</span><span class="sxs-lookup"><span data-stu-id="64cd6-147">Default route (Internet and all Internet-based services) goes direct.</span></span> |
| [<span data-ttu-id="64cd6-148">5. 无 VPN</span><span class="sxs-lookup"><span data-stu-id="64cd6-148">5. No VPN</span></span>](#5-no-vpn) | <span data-ttu-id="64cd6-149">#2 (的一种变体，其中所有公司网络服务都通过现代安全方法（如 Zscaler ZPA、Azure Active Directory (Azure AD) Proxy/MCAS 等）发布) </span><span class="sxs-lookup"><span data-stu-id="64cd6-149">A variation of #2, where instead of legacy VPN, all corpnet services are published through modern security approaches (like Zscaler ZPA, Azure Active Directory (Azure AD) Proxy/MCAS, etc.)</span></span> |

### <a name="1-vpn-forced-tunnel"></a><span data-ttu-id="64cd6-150">1. VPN 强制隧道</span><span class="sxs-lookup"><span data-stu-id="64cd6-150">1. VPN Forced Tunnel</span></span>

<span data-ttu-id="64cd6-151">这是大多数企业客户最常用的入门方案。</span><span class="sxs-lookup"><span data-stu-id="64cd6-151">This is the most common starting scenario for most enterprise customers.</span></span> <span data-ttu-id="64cd6-152">使用强制 VPN，这意味着 100% 的流量将定向到企业网络，无论终结点是否驻留在企业网络内。</span><span class="sxs-lookup"><span data-stu-id="64cd6-152">A forced VPN is used, which means 100% of traffic is directed into the corporate network regardless of the fact the endpoint resides within the corporate network or not.</span></span> <span data-ttu-id="64cd6-153">然后， (Internet) 流量（如 Office 365 或 Internet 浏览）的任何外部流量都回发回本地安全设备（如代理）。</span><span class="sxs-lookup"><span data-stu-id="64cd6-153">Any external (Internet) bound traffic such as Office 365 or Internet browsing is then hair-pinned back out of the on premises security equipment such as proxies.</span></span> <span data-ttu-id="64cd6-154">在当前近 100% 的用户远程工作的当前情况中，此模型会给 VPN 基础结构带来高负载，并且可能会显著妨碍所有公司流量的性能，进而使企业在危机时高效运行。</span><span class="sxs-lookup"><span data-stu-id="64cd6-154">In the current climate with nearly 100% of users working remotely, this model therefore puts high load on the VPN infrastructure and is likely to significantly hinder performance of all corporate traffic and thus the enterprise to operate efficiently at a time of crisis.</span></span>

![VPN 强制隧道模型 1](../media/vpn-split-tunneling/vpn-model-1.png)

### <a name="2-vpn-forced-tunnel-with-a-small-number-of-trusted-exceptions"></a><span data-ttu-id="64cd6-156">2. VPN 强制隧道（有几个受信任的异常）</span><span class="sxs-lookup"><span data-stu-id="64cd6-156">2. VPN Forced Tunnel with a small number of trusted exceptions</span></span>

<span data-ttu-id="64cd6-157">此模型对于企业运行的效率明显更高，因为它允许几个对负载和延迟非常敏感的受控和定义的终结点绕过 VPN 隧道并直接转到此示例中的 Office 365 服务。</span><span class="sxs-lookup"><span data-stu-id="64cd6-157">This model is significantly more efficient for an enterprise to operate under as it allows a few controlled and defined endpoints that are very high load and latency sensitive to bypass the VPN tunnel and go direct to the Office 365 service in this example.</span></span> <span data-ttu-id="64cd6-158">这显著提高了卸载服务的性能，还减少了 VPN 基础结构上的负载，从而允许仍然需要它的元素以较低的资源争用运行。</span><span class="sxs-lookup"><span data-stu-id="64cd6-158">This significantly improves the performance for the offloaded services, and also decreases the load on the VPN infrastructure, thus allowing elements that still require it to operate with lower contention for resources.</span></span> <span data-ttu-id="64cd6-159">正是此模型，本文侧重于协助过渡到 ，因为它允许快速执行简单的已定义操作，并产生大量积极的结果。</span><span class="sxs-lookup"><span data-stu-id="64cd6-159">It is this model that this article concentrates on assisting with the transition to as it allows for simple, defined actions to be taken quickly with numerous positive outcomes.</span></span>

![拆分隧道 VPN 模型 2](../media/vpn-split-tunneling/vpn-model-2.png)

### <a name="3-vpn-forced-tunnel-with-broad-exceptions"></a><span data-ttu-id="64cd6-161">3. VPN 强制隧道（有多个例外）</span><span class="sxs-lookup"><span data-stu-id="64cd6-161">3. VPN Forced Tunnel with broad exceptions</span></span>

<span data-ttu-id="64cd6-162">第三个模型扩大模型 2 的范围，而不是直接发送一小组定义的终结点，而是直接将所有流量发送到受信任的服务（如 Office 365 和 SalesForce）。</span><span class="sxs-lookup"><span data-stu-id="64cd6-162">The third model broadens the scope of model two as rather than just sending a small group of defined endpoints direct, it instead sends all traffic directly to trusted services such Office 365 and SalesForce.</span></span> <span data-ttu-id="64cd6-163">这可进一步减少公司 VPN 基础结构的负载，并提高已定义服务的性能。</span><span class="sxs-lookup"><span data-stu-id="64cd6-163">This further reduces the load on the corporate VPN infrastructure and improves the performance of the services defined.</span></span> <span data-ttu-id="64cd6-164">由于此模型可能需要更多时间来评估和实施是否可行，因此，一旦模型 2 成功就位，稍后可能会反复执行一个步骤。</span><span class="sxs-lookup"><span data-stu-id="64cd6-164">As this model is likely to take more time to assess the feasibility of and implement, it is likely a step that can be taken iteratively at a later date once model two is successfully in place.</span></span>

![拆分隧道 VPN 模型 3](../media/vpn-split-tunneling/vpn-model-3.png)

### <a name="4-vpn-selective-tunnel"></a><span data-ttu-id="64cd6-166">4. VPN 选择性隧道</span><span class="sxs-lookup"><span data-stu-id="64cd6-166">4. VPN selective Tunnel</span></span>

<span data-ttu-id="64cd6-167">此模型与第三个模型相反，因为只有标识为具有公司 IP 地址的流量才通过 VPN 隧道发送，因此 Internet 路径是其他所有流量的默认路由。</span><span class="sxs-lookup"><span data-stu-id="64cd6-167">This model reverses the third model in that only traffic identified as having a corporate IP address is sent down the VPN tunnel and thus the Internet path is the default route for everything else.</span></span> <span data-ttu-id="64cd6-168">此模型要求组织能够很好地适应[零信任](https://www.microsoft.com/security/zero-trust?rtc=1)路径，以便能够安全地实现此模型。</span><span class="sxs-lookup"><span data-stu-id="64cd6-168">This model requires an organization to be well on the path to [Zero Trust](https://www.microsoft.com/security/zero-trust?rtc=1) in able to safely implement this model.</span></span> <span data-ttu-id="64cd6-169">应注意的是，此模型或某些变体可能随着时间的推移而成为必要的默认模型，因为越来越多的服务将从公司网络移动到云中。</span><span class="sxs-lookup"><span data-stu-id="64cd6-169">It should be noted that this model or some variation thereof will likely become the necessary default over time as more and more services move away from the corporate network and into the cloud.</span></span> <span data-ttu-id="64cd6-170">Microsoft 在内部使用此模型；有关 Microsoft 实现 VPN 拆分隧道的更多信息，请参阅[运行 VPN：Microsoft 如何让远程工作人员互联](https://www.microsoft.com/itshowcase/blog/running-on-vpn-how-microsoft-is-keeping-its-remote-workforce-connected/?elevate-lv)。</span><span class="sxs-lookup"><span data-stu-id="64cd6-170">Microsoft uses this model internally; you can find more information on Microsoft's implementation of VPN split tunneling at [Running on VPN: How Microsoft is keeping its remote workforce connected](https://www.microsoft.com/itshowcase/blog/running-on-vpn-how-microsoft-is-keeping-its-remote-workforce-connected/?elevate-lv).</span></span>

![拆分隧道 VPN 模型 4](../media/vpn-split-tunneling/vpn-model-4.png)

### <a name="5-no-vpn"></a><span data-ttu-id="64cd6-172">5. 无 VPN</span><span class="sxs-lookup"><span data-stu-id="64cd6-172">5. No VPN</span></span>

<span data-ttu-id="64cd6-173">第二个型号的更高级版本，其中任何内部服务都通过现代安全方法或 SDWAN 解决方案（如 Azure AD 代理、MCAS、Zscaler ZPA 等）发布。</span><span class="sxs-lookup"><span data-stu-id="64cd6-173">A more advanced version of model number two, whereby any internal services are published through a modern security approach or SDWAN solution such as Azure AD Proxy, MCAS, Zscaler ZPA, etc.</span></span>

![拆分隧道 VPN 模型 5](../media/vpn-split-tunneling/vpn-model-5.png)

## <a name="implement-vpn-split-tunneling"></a><span data-ttu-id="64cd6-175">实现 VPN 拆分隧道</span><span class="sxs-lookup"><span data-stu-id="64cd6-175">Implement VPN split tunneling</span></span>

<span data-ttu-id="64cd6-176">在此部分中，你将找到将 VPN 客户端体系结构从 _VPN_ 强制隧道迁移到具有少量受信任异常的 _VPN_ 强制隧道所需的简单步骤，VPN 拆分隧道模型 [#2](#2-vpn-forced-tunnel-with-a-small-number-of-trusted-exceptions) 常见 [VPN](#common-vpn-scenarios)方案中。</span><span class="sxs-lookup"><span data-stu-id="64cd6-176">In this section, you'll find the simple steps required to migrate your VPN client architecture from a _VPN forced tunnel_ to a _VPN forced tunnel with a small number of trusted exceptions_, [VPN split tunnel model #2](#2-vpn-forced-tunnel-with-a-small-number-of-trusted-exceptions) in [Common VPN scenarios](#common-vpn-scenarios).</span></span>

<span data-ttu-id="64cd6-177">下图显示了建议的 VPN 拆分隧道解决方案的工作原理：</span><span class="sxs-lookup"><span data-stu-id="64cd6-177">The diagram below illustrates how the recommended VPN split tunnel solution works:</span></span>

![拆分隧道 VPN 解决方案详细信息](../media/vpn-split-tunneling/vpn-split-tunnel-example.png)

### <a name="1-identify-the-endpoints-to-optimize"></a><span data-ttu-id="64cd6-179">1. 标识要优化的终结点</span><span class="sxs-lookup"><span data-stu-id="64cd6-179">1. Identify the endpoints to optimize</span></span>

<span data-ttu-id="64cd6-180">在 [Office 365 URL 和 IP 地址范围](urls-and-ip-address-ranges.md)主题中，Microsoft 明确标识需优化的关键终结点，并将其分类为“优化”。</span><span class="sxs-lookup"><span data-stu-id="64cd6-180">In the [Office 365 URLs and IP address ranges](urls-and-ip-address-ranges.md) topic, Microsoft clearly identifies the key endpoints you need to optimize and categorizes them as **Optimize**.</span></span> <span data-ttu-id="64cd6-181">目前仅需要优化四个 URL 和 20 个 IP 子网。</span><span class="sxs-lookup"><span data-stu-id="64cd6-181">There are currently just four URLS and 20 IP subnets that need to be optimized.</span></span> <span data-ttu-id="64cd6-182">这一小组的终结点约占 Office 365 服务流量的 70% - 80%，包括延迟敏感终结点（如 Teams 媒体终结点）。</span><span class="sxs-lookup"><span data-stu-id="64cd6-182">This small group of endpoints accounts for around 70% - 80% of the volume of traffic to the Office 365 service including the latency sensitive endpoints such as those for Teams media.</span></span> <span data-ttu-id="64cd6-183">实质上，这是我们需要特别注意的流量，也是对传统网络路径和 VPN 基础结构造成压力的流量。</span><span class="sxs-lookup"><span data-stu-id="64cd6-183">Essentially this is the traffic that we need to take special care of and is also the traffic that will put incredible pressure on traditional network paths and VPN infrastructure.</span></span>

<span data-ttu-id="64cd6-184">此类别中的 URL 具有以下特征：</span><span class="sxs-lookup"><span data-stu-id="64cd6-184">URLs in this category have the following characteristics:</span></span>

- <span data-ttu-id="64cd6-185">为 Microsoft 拥有和托管的终结点，托管在 Microsoft 基础结构上</span><span class="sxs-lookup"><span data-stu-id="64cd6-185">Are Microsoft owned and managed endpoints, hosted on Microsoft infrastructure</span></span>
- <span data-ttu-id="64cd6-186">提供了 IP</span><span class="sxs-lookup"><span data-stu-id="64cd6-186">Have IPs provided</span></span>
- <span data-ttu-id="64cd6-187">低更改率，预计仍保持较小数量（目前有 20 个 IP 子网）</span><span class="sxs-lookup"><span data-stu-id="64cd6-187">Low rate of change and are expected to remain small in number (currently 20 IP subnets)</span></span>
- <span data-ttu-id="64cd6-188">带宽和/或延迟敏感</span><span class="sxs-lookup"><span data-stu-id="64cd6-188">Are bandwidth and/or latency sensitive</span></span>
- <span data-ttu-id="64cd6-189">可在服务中提供所需的安全元素，而不是在网络上内联</span><span class="sxs-lookup"><span data-stu-id="64cd6-189">Are able to have required security elements provided in the service rather than inline on the network</span></span>
- <span data-ttu-id="64cd6-190">约占 Office 365 服务流量的 70-80%</span><span class="sxs-lookup"><span data-stu-id="64cd6-190">Account for around 70-80% of the volume of traffic to the Office 365 service</span></span>

<span data-ttu-id="64cd6-191">有关 Office 365 终结点及其分类和管理方式的详细信息，请参阅[管理 Office 365 终结点](managing-office-365-endpoints.md)一文。</span><span class="sxs-lookup"><span data-stu-id="64cd6-191">For more information about Office 365 endpoints and how they are categorized and managed, see the article [Managing Office 365 endpoints](managing-office-365-endpoints.md).</span></span>

#### <a name="optimize-urls"></a><span data-ttu-id="64cd6-192">优化 URL</span><span class="sxs-lookup"><span data-stu-id="64cd6-192">Optimize URLs</span></span>

<span data-ttu-id="64cd6-193">可在下表找到当前的优化 URL。</span><span class="sxs-lookup"><span data-stu-id="64cd6-193">The current Optimize URLs can be found in the table below.</span></span> <span data-ttu-id="64cd6-194">在大多数情况下，只需在[浏览器 PAC 文件](managing-office-365-endpoints.md#use-a-pac-file-for-direct-routing-of-vital-office-365-traffic)中使用 URL 终结点，其中终结点被配置为直接发送，而不是发送到代理。</span><span class="sxs-lookup"><span data-stu-id="64cd6-194">Under most circumstances, you should only need to use URL endpoints in a [browser PAC file](managing-office-365-endpoints.md#use-a-pac-file-for-direct-routing-of-vital-office-365-traffic) where the endpoints are configured to be sent direct, rather than to the proxy.</span></span>

| <span data-ttu-id="64cd6-195">优化 URL</span><span class="sxs-lookup"><span data-stu-id="64cd6-195">Optimize URLs</span></span> | <span data-ttu-id="64cd6-196">端口/协议</span><span class="sxs-lookup"><span data-stu-id="64cd6-196">Port/Protocol</span></span> | <span data-ttu-id="64cd6-197">用途</span><span class="sxs-lookup"><span data-stu-id="64cd6-197">Purpose</span></span> |
| --- | --- | --- |
| <https://outlook.office365.com> | <span data-ttu-id="64cd6-198">TCP 443</span><span class="sxs-lookup"><span data-stu-id="64cd6-198">TCP 443</span></span> | <span data-ttu-id="64cd6-199">这是 Outlook 用于连接到其 Exchange Online Server 并具有较高带宽使用率和连接计数的主要 URL 之一。</span><span class="sxs-lookup"><span data-stu-id="64cd6-199">This is one of the primary URLs Outlook uses to connect to its Exchange Online server and has a high volume of bandwidth usage and connection count.</span></span> <span data-ttu-id="64cd6-200">以下联机功能需要低网络延迟：即时搜索、其他邮箱日历、忙/闲查找、管理规则和通知、Exchange Online 存档和电子邮件传出发件箱。</span><span class="sxs-lookup"><span data-stu-id="64cd6-200">Low network latency is required for online features including: instant search, other mailbox calendars, free / busy lookup, manage rules and alerts, Exchange online archive, emails departing the outbox.</span></span> |
| <https://outlook.office.com> | <span data-ttu-id="64cd6-201">TCP 443</span><span class="sxs-lookup"><span data-stu-id="64cd6-201">TCP 443</span></span> | <span data-ttu-id="64cd6-202">此 URL 供 Outlook Online Web 访问用于连接到 Exchange Online Server，并且对网络延迟非常敏感。</span><span class="sxs-lookup"><span data-stu-id="64cd6-202">This URL is used for Outlook Online Web Access to connect to Exchange Online server, and is sensitive to network latency.</span></span> <span data-ttu-id="64cd6-203">使用 SharePoint Online 上传和下载大型文件尤其需要连接。</span><span class="sxs-lookup"><span data-stu-id="64cd6-203">Connectivity is particularly required for large file upload and download with SharePoint Online.</span></span> |
| <span data-ttu-id="64cd6-204"> https:// \<tenant\> .sharepoint.com</span><span class="sxs-lookup"><span data-stu-id="64cd6-204">https://\<tenant\>.sharepoint.com</span></span> | <span data-ttu-id="64cd6-205">TCP 443</span><span class="sxs-lookup"><span data-stu-id="64cd6-205">TCP 443</span></span> | <span data-ttu-id="64cd6-206">这是 SharePoint Online 的主要 URL，并且具有高带宽使用率。</span><span class="sxs-lookup"><span data-stu-id="64cd6-206">This is the primary URL for SharePoint Online and has high-bandwidth usage.</span></span> |
| <span data-ttu-id="64cd6-207"> https:// \<tenant\> -my.sharepoint.com</span><span class="sxs-lookup"><span data-stu-id="64cd6-207">https://\<tenant\>-my.sharepoint.com</span></span> | <span data-ttu-id="64cd6-208">TCP 443</span><span class="sxs-lookup"><span data-stu-id="64cd6-208">TCP 443</span></span> | <span data-ttu-id="64cd6-209">这是 OneDrive for business 的主要 URL，具有较高的带宽使用率，并且可能会产生来自 OneDrive for Business 同步工具的高连接计数。</span><span class="sxs-lookup"><span data-stu-id="64cd6-209">This is the primary URL for OneDrive for Business and has high bandwidth usage and possibly high connection count from the OneDrive for Business Sync tool.</span></span> |
| <span data-ttu-id="64cd6-210">Teams 媒体 IP（无 URL）</span><span class="sxs-lookup"><span data-stu-id="64cd6-210">Teams Media IPs (no URL)</span></span> | <span data-ttu-id="64cd6-211">UDP 3478、3479、3480 和 3481</span><span class="sxs-lookup"><span data-stu-id="64cd6-211">UDP 3478, 3479, 3480, and 3481</span></span> | <span data-ttu-id="64cd6-212">中继发现分配和实时流量 (3478) 、音频 (3479) 、视频 (3480) 和视频屏幕共享 (3481) 。</span><span class="sxs-lookup"><span data-stu-id="64cd6-212">Relay Discovery allocation and real-time traffic (3478), Audio (3479), Video (3480), and Video Screen Sharing (3481).</span></span> <span data-ttu-id="64cd6-213">这些终结点用于Skype for Business Microsoft Teams媒体流量 (通话、会议等) 。</span><span class="sxs-lookup"><span data-stu-id="64cd6-213">These are the endpoints used for Skype for Business and Microsoft Teams Media traffic (calls, meetings, etc.).</span></span> <span data-ttu-id="64cd6-214">当 Microsoft Teams 客户端建立呼叫时，将提供大多数终结点（并包含在为该服务列出的所需 IP 内）。</span><span class="sxs-lookup"><span data-stu-id="64cd6-214">Most endpoints are provided when the Microsoft Teams client establishes a call (and are contained within the required IPs listed for the service).</span></span> <span data-ttu-id="64cd6-215">若要获得最佳媒体质量，需要使用 UDP 协议。</span><span class="sxs-lookup"><span data-stu-id="64cd6-215">Use of the UDP protocol is required for optimal media quality.</span></span>   |

<span data-ttu-id="64cd6-216">在上面的示例中，应将 **租户** 替换为 Office 365 租户名称。</span><span class="sxs-lookup"><span data-stu-id="64cd6-216">In the above examples, **tenant** should be replaced with your Office 365 tenant name.</span></span> <span data-ttu-id="64cd6-217">例如，**contoso.onmicrosoft.com** 将使用 _contoso.sharepoint.com_ 和 _constoso-my.sharepoint.com_。</span><span class="sxs-lookup"><span data-stu-id="64cd6-217">For example, **contoso.onmicrosoft.com** would use _contoso.sharepoint.com_ and _constoso-my.sharepoint.com_.</span></span>

#### <a name="optimize-ip-address-ranges"></a><span data-ttu-id="64cd6-218">优化 IP 地址范围</span><span class="sxs-lookup"><span data-stu-id="64cd6-218">Optimize IP address ranges</span></span>

<span data-ttu-id="64cd6-219">在编写这些终结点所对应的 IP 范围时，如下所示。</span><span class="sxs-lookup"><span data-stu-id="64cd6-219">At the time of writing the IP ranges that these endpoints correspond to are as follows.</span></span> <span data-ttu-id="64cd6-220">强烈建议你在应用配置时使用脚本（如[](https://github.com/microsoft/Office365NetworkTools/tree/master/Scripts/Display%20URL-IPs-Ports%20per%20Category)此示例[、Office 365 IP](microsoft-365-ip-web-service.md)和 URL Web 服务或[URL/IP](urls-and-ip-address-ranges.md)页面）检查是否有更新，并定期制定策略。</span><span class="sxs-lookup"><span data-stu-id="64cd6-220">It is **very strongly** advised you use a [script such as this](https://github.com/microsoft/Office365NetworkTools/tree/master/Scripts/Display%20URL-IPs-Ports%20per%20Category) example, the [Office 365 IP and URL web service](microsoft-365-ip-web-service.md) or the [URL/IP page](urls-and-ip-address-ranges.md) to check for any updates when applying the configuration, and put a policy in place to do so regularly.</span></span>

```
104.146.128.0/17
13.107.128.0/22
13.107.136.0/22
13.107.18.10/31
13.107.6.152/31
13.107.64.0/18
131.253.33.215/32
132.245.0.0/16
150.171.32.0/22
150.171.40.0/22
191.234.140.0/22
204.79.197.215/32
23.103.160.0/20
40.104.0.0/15
40.108.128.0/17
40.96.0.0/13
52.104.0.0/14
52.112.0.0/14
52.96.0.0/14
52.120.0.0/14
```

### <a name="2-optimize-access-to-these-endpoints-via-the-vpn"></a><span data-ttu-id="64cd6-221">2. 通过 VPN 优化对这些终结点的访问</span><span class="sxs-lookup"><span data-stu-id="64cd6-221">2. Optimize access to these endpoints via the VPN</span></span>

<span data-ttu-id="64cd6-222">我们已确定这些关键终结点，现在需要将其从 VPN 隧道移出，并允许它们使用用户的本地 Internet 连接直接连接到服务。</span><span class="sxs-lookup"><span data-stu-id="64cd6-222">Now that we have identified these critical endpoints, we need to divert them away from the VPN tunnel and allow them to use the user's local Internet connection to connect directly to the service.</span></span> <span data-ttu-id="64cd6-223">完成此操作的方式将因使用的 VPN 产品和计算机平台而异，但大多数 VPN 解决方案将允许简单配置策略来应用此逻辑。</span><span class="sxs-lookup"><span data-stu-id="64cd6-223">The manner in which this is accomplished will vary depending on the VPN product and machine platform used but most VPN solutions will allow some simple configuration of policy to apply this logic.</span></span> <span data-ttu-id="64cd6-224">有关 VPN 平台特定的拆分隧道指南，请参阅[常见 VPN 平台的操作指南](#howto-guides-for-common-vpn-platforms)。</span><span class="sxs-lookup"><span data-stu-id="64cd6-224">For information VPN platform-specific split tunnel guidance, see [HOWTO guides for common VPN platforms](#howto-guides-for-common-vpn-platforms).</span></span>

<span data-ttu-id="64cd6-225">如果要手动测试解决方案，可执行以下 PowerShell 示例，以在路由表级别模拟解决方案。</span><span class="sxs-lookup"><span data-stu-id="64cd6-225">If you wish to test the solution manually, you can execute the following PowerShell example to emulate the solution at the route table level.</span></span> <span data-ttu-id="64cd6-226">本例将每个 Teams 媒体 IP 子网的路由添加到路由表中。</span><span class="sxs-lookup"><span data-stu-id="64cd6-226">This example adds a route for each of the Teams Media IP subnets into the route table.</span></span> <span data-ttu-id="64cd6-227">可以在之前和之后测试 Teams 媒体性能，并观察指定终结点路由的差异。</span><span class="sxs-lookup"><span data-stu-id="64cd6-227">You can test Teams media performance before and after, and observe the difference in routes for the specified endpoints.</span></span>

#### <a name="example-add-teams-media-ip-subnets-into-the-route-table"></a><span data-ttu-id="64cd6-228">示例：将 Teams 媒体 IP 子网添加到路由表</span><span class="sxs-lookup"><span data-stu-id="64cd6-228">Example: Add Teams Media IP subnets into the route table</span></span>

```powershell
$intIndex = "" # index of the interface connected to the internet
$gateway = "" # default gateway of that interface
$destPrefix = "52.120.0.0/14", "52.112.0.0/14", "13.107.64.0/18" # Teams Media endpoints
# Add routes to the route table
foreach ($prefix in $destPrefix) {New-NetRoute -DestinationPrefix $prefix -InterfaceIndex $intIndex -NextHop $gateway}
```

<span data-ttu-id="64cd6-229">在上面的脚本中，_$intIndex_ 是连接到 Internet 的接口索引（可通过在 PowerShell 中运行 **get-netadapter** 找到；查找 _ifIndex_ 的值），_$gateway_ 是该接口的默认网关（可通过在命令提示符中运行 **ipconfig** 或在 PowerShell 中运行 **(Get-NetIPConfiguration | Foreach IPv4DefaultGateway).NextHop** 找到）。</span><span class="sxs-lookup"><span data-stu-id="64cd6-229">In the above script, _$intIndex_ is the index of the interface connected to the internet (find by running **get-netadapter** in PowerShell; look for the value of _ifIndex_) and _$gateway_ is the default gateway of that interface (find by running **ipconfig** in a command prompt or **(Get-NetIPConfiguration | Foreach IPv4DefaultGateway).NextHop** in PowerShell).</span></span>

<span data-ttu-id="64cd6-230">添加路由后，可通过在命令提示符或 PowerShell 中运行 **route print** 来确认路由表是否正确。</span><span class="sxs-lookup"><span data-stu-id="64cd6-230">Once you have added the routes, you can confirm that the route table is correct by running **route print** in a command prompt or PowerShell.</span></span> <span data-ttu-id="64cd6-231">输出应包含添加的路由，显示接口索引（本例为 _22_）和该接口的网关（本例为 _192.168.1.1_）：</span><span class="sxs-lookup"><span data-stu-id="64cd6-231">The output should contain the routes you added, showing the interface index (_22_ in this example) and the gateway for that interface (_192.168.1.1_ in this example):</span></span>

![路由打印输出](../media/vpn-split-tunneling/vpn-route-print.png)

<span data-ttu-id="64cd6-233">若要在“优化”类别中添加 **所有** 当前 IP 地址范围的路由，可使用以下脚本变体查询 [Office 365 IP 和 URL Web 服务](microsoft-365-ip-web-service.md)，以获取当前优化 IP 子网集合并将其添加到路由表。</span><span class="sxs-lookup"><span data-stu-id="64cd6-233">To add routes for **all** current IP address ranges in the Optimize category, you can use the following script variation to query the [Office 365 IP and URL web service](microsoft-365-ip-web-service.md) for the current set of Optimize IP subnets and add them to the route table.</span></span>

#### <a name="example-add-all-optimize-subnets-into-the-route-table"></a><span data-ttu-id="64cd6-234">示例：将所有优化子网添加到路由表</span><span class="sxs-lookup"><span data-stu-id="64cd6-234">Example: Add all Optimize subnets into the route table</span></span>

```powershell
$intIndex = "" # index of the interface connected to the internet
$gateway = "" # default gateway of that interface
# Query the web service for IPs in the Optimize category
$ep = Invoke-RestMethod ("https://endpoints.office.com/endpoints/worldwide?clientrequestid=" + ([GUID]::NewGuid()).Guid)
# Output only IPv4 Optimize IPs to $optimizeIps
$destPrefix = $ep | where {$_.category -eq "Optimize"} | Select-Object -ExpandProperty ips | Where-Object { $_ -like '*.*' }
# Add routes to the route table
foreach ($prefix in $destPrefix) {New-NetRoute -DestinationPrefix $prefix -InterfaceIndex $intIndex -NextHop $gateway}
```

<span data-ttu-id="64cd6-235">如果无意中添加了错误参数的路由，或者只是希望还原所做的更改，则可以使用以下命令删除刚添加的路由：</span><span class="sxs-lookup"><span data-stu-id="64cd6-235">If you inadvertently added routes with incorrect parameters or simply wish to revert your changes, you can remove the routes you just added with the following command:</span></span>

```powershell
foreach ($prefix in $destPrefix) {Remove-NetRoute -DestinationPrefix $prefix -InterfaceIndex $intIndex -NextHop $gateway}
```

<!--- remmed until we add more reliable interface selection logic
#### Example script to add Teams Media subnets to the route table

```powershell
$adapter = get-netadapter | ? {$_.Status -eq "Up"}
$adapterIndex = $adapter.ifIndex
$gateway = (Get-NetIPConfiguration | Foreach IPv4DefaultGateway).NextHop

$destPrefix = "52.120.0.0/14", "52.112.0.0/14", "13.107.64.0/18"
foreach ($prefix in $destPrefix) {New-NetRoute -DestinationPrefix $prefix -InterfaceIndex $intIndex -NextHop $gateway}
```
-->

<span data-ttu-id="64cd6-236">应配置 VPN 客户端，以便 **优化** IP 的流量以此方式路由。</span><span class="sxs-lookup"><span data-stu-id="64cd6-236">The VPN client should be configured so that traffic to the **Optimize** IPs are routed in this way.</span></span> <span data-ttu-id="64cd6-237">这允许流量利用本地 Microsoft 资源，如 Office 365 Service Front [Door，如 Azure Front Door，](https://azure.microsoft.com/blog/azure-front-door-service-is-now-generally-available/)可提供尽可能接近你的用户的 Office 365 服务和连接终结点。</span><span class="sxs-lookup"><span data-stu-id="64cd6-237">This allows the traffic to utilize local Microsoft resources such as Office 365 Service Front Doors [such as the Azure Front Door](https://azure.microsoft.com/blog/azure-front-door-service-is-now-generally-available/) that deliver Office 365 services and connectivity endpoints as close to your users as possible.</span></span> <span data-ttu-id="64cd6-238">这使我们能够为位于世界任何位置的用户提供高性能级别，并充分利用 [Microsoft](https://azure.microsoft.com/blog/how-microsoft-builds-its-fast-and-reliable-global-network/)的世界一流的全局网络，这很可能在用户的直接出口几毫秒内完成。</span><span class="sxs-lookup"><span data-stu-id="64cd6-238">This allows us to deliver high performance levels to users wherever they are in the world and takes full advantage of [Microsoft's world class global network](https://azure.microsoft.com/blog/how-microsoft-builds-its-fast-and-reliable-global-network/), which is likely within a few milliseconds of your users' direct egress.</span></span>

## <a name="configuring-and-securing-teams-media-traffic"></a><span data-ttu-id="64cd6-239">配置和保护 Teams 媒体流量</span><span class="sxs-lookup"><span data-stu-id="64cd6-239">Configuring and securing Teams media traffic</span></span>

<span data-ttu-id="64cd6-240">一些管理员可能需要更详细的信息，了解如何在使用拆分隧道模型的 Teams 中进行呼叫流操作，以及如何保护连接。</span><span class="sxs-lookup"><span data-stu-id="64cd6-240">Some administrators may require more detailed information on how call flows operate in Teams using a split tunneling model and how connections are secured.</span></span>

### <a name="configuration"></a><span data-ttu-id="64cd6-241">配置</span><span class="sxs-lookup"><span data-stu-id="64cd6-241">Configuration</span></span>

<span data-ttu-id="64cd6-242">对于呼叫和会议，只要路由表中正确放置了 Teams 媒体所需的"优化 IP 子网"，当 Teams 调用[GetBestRoute](/windows/win32/api/iphlpapi/nf-iphlpapi-getbestroute)函数来确定哪个本地接口对应于它应用于特定目的地的路由时，将为上面列出的 Microsoft IP 块中的 Microsoft 目标返回本地接口。</span><span class="sxs-lookup"><span data-stu-id="64cd6-242">For both calls and meetings, as long as the required Optimize IP subnets for Teams media are correctly in place in the route table, when Teams calls the [GetBestRoute](/windows/win32/api/iphlpapi/nf-iphlpapi-getbestroute) function to determine which local interface corresponds to the route it should use for a particular destination, the local interface will be returned for Microsoft destinations in the Microsoft IP blocks listed above.</span></span>

<span data-ttu-id="64cd6-243">某些 VPN 客户端软件允许基于 URL 进行路由操作。</span><span class="sxs-lookup"><span data-stu-id="64cd6-243">Some VPN client software allows routing manipulation based on URL.</span></span> <span data-ttu-id="64cd6-244">但是，Teams 媒体流量没有与之关联的 URL，因此必须使用 IP 子网来控制此流量路由。</span><span class="sxs-lookup"><span data-stu-id="64cd6-244">However, Teams media traffic has no URL associated with it, so control of routing for this traffic must be done using IP subnets.</span></span>

<span data-ttu-id="64cd6-245">在某些情况下（通常与 Teams 客户端配置无关），即使有正确的路由，媒体流量仍会遍历 VPN 隧道。</span><span class="sxs-lookup"><span data-stu-id="64cd6-245">In certain scenarios, often unrelated to Teams client configuration, media traffic still traverses the VPN tunnel even with the correct routes in place.</span></span> <span data-ttu-id="64cd6-246">如果遇到这种情况，则使用防火墙规则阻止 ip Teams或端口使用 VPN 就足够了。</span><span class="sxs-lookup"><span data-stu-id="64cd6-246">If you encounter this scenario, then using a firewall rule to block the Teams IP subnets or ports from using the VPN should suffice.</span></span>

>[!IMPORTANT]
><span data-ttu-id="64cd6-247">若要Teams VPN 方案中通过所需方法路由媒体流量，请确保用户运行的是 Microsoft Teams 客户端版本 **1.3.00.13565** 或更大版本。</span><span class="sxs-lookup"><span data-stu-id="64cd6-247">To ensure Teams media traffic is routed via the desired method in all VPN scenarios, please ensure users are running Microsoft Teams client version **1.3.00.13565** or greater.</span></span> <span data-ttu-id="64cd6-248">此版本包括客户端检测可用网络路径的改进。</span><span class="sxs-lookup"><span data-stu-id="64cd6-248">This version includes improvements in how the client detects available network paths.</span></span>

<span data-ttu-id="64cd6-249">信号流量通过 HTTPS 执行，对延迟没有媒体流量敏感，在 URL/IP 数据中标记为"允许"，因此如果需要，可以安全地通过 VPN 客户端进行路由。</span><span class="sxs-lookup"><span data-stu-id="64cd6-249">Signaling traffic is performed over HTTPS and is not as latency sensitive as the media traffic and is marked as **Allow** in the URL/IP data and thus can safely be routed through the VPN client if desired.</span></span>

### <a name="security"></a><span data-ttu-id="64cd6-250">安全性</span><span class="sxs-lookup"><span data-stu-id="64cd6-250">Security</span></span>

<span data-ttu-id="64cd6-251">避免拆分隧道的一个常见理由是这样做不太安全，也就是说，</span><span class="sxs-lookup"><span data-stu-id="64cd6-251">One common argument for avoiding split tunnels is that it is less secure to do so, i.e</span></span> <span data-ttu-id="64cd6-252">任何不通过 VPN 隧道的流量都将无法从应用到 VPN 隧道的任何加密方案中受益，因此安全性较低。</span><span class="sxs-lookup"><span data-stu-id="64cd6-252">any traffic that does not go through the VPN tunnel will not benefit from whatever encryption scheme is applied to the VPN tunnel, and is therefore less secure.</span></span>

<span data-ttu-id="64cd6-253">对此的主要反对意见是，媒体流量已经通过 _安全实时传输协议 (SRTP)_ 进行了加密，该协议是实时传输协议 (RTP) 的一个配置文件，它为 RTP 流量提供保密性、身份验证和重播攻击保护。</span><span class="sxs-lookup"><span data-stu-id="64cd6-253">The main counter-argument to this is that media traffic is already encrypted via _Secure Real-Time Transport Protocol (SRTP)_, a profile of Real-Time Transport Protocol (RTP) that provides confidentiality, authentication, and replay attack protection to RTP traffic.</span></span> <span data-ttu-id="64cd6-254">SRTP 本身依赖于随机生成的会话密钥，该密钥通过 TLS 安全信令通道进行交换。</span><span class="sxs-lookup"><span data-stu-id="64cd6-254">SRTP itself relies on a randomly generated session key, which is exchanged via the TLS secured signaling channel.</span></span> <span data-ttu-id="64cd6-255">[本安全指南](/skypeforbusiness/optimizing-your-network/security-guide-for-skype-for-business-online)中详细介绍了这一点，但主要部分是媒体加密。</span><span class="sxs-lookup"><span data-stu-id="64cd6-255">This is covered in great detail within [this security guide](/skypeforbusiness/optimizing-your-network/security-guide-for-skype-for-business-online), but the primary section of interest is media encryption.</span></span>

<span data-ttu-id="64cd6-256">媒体流量是使用 SRTP 加密的，SRTP 使用安全随机数生成器生成的会话密钥，并使用信令 TLS 通道进行交换。</span><span class="sxs-lookup"><span data-stu-id="64cd6-256">Media traffic is encrypted using SRTP, which uses a session key generated by a secure random number generator and exchanged using the signaling TLS channel.</span></span> <span data-ttu-id="64cd6-257">此外，在中介服务器和其内部下一个跃点之间的双向媒体也使用 SRTP 进行加密。</span><span class="sxs-lookup"><span data-stu-id="64cd6-257">In addition, media flowing in both directions between the Mediation Server and its internal next hop is also encrypted using SRTP.</span></span>

<span data-ttu-id="64cd6-258">Skype for Business Online 生成用户名/密码，可用于通过 _围绕 NAT 使用中继遍历 (TURN)_ 来安全访问媒体中继。</span><span class="sxs-lookup"><span data-stu-id="64cd6-258">Skype for Business Online generates username/passwords for secure access to media relays over _Traversal Using Relays around NAT (TURN)_.</span></span> <span data-ttu-id="64cd6-259">媒体中继通过 TLS 安全 SIP 信道交换用户名/密码。</span><span class="sxs-lookup"><span data-stu-id="64cd6-259">Media relays exchange the username/password over a TLS-secured SIP channel.</span></span> <span data-ttu-id="64cd6-260">值得注意的是，即使可使用 VPN 隧道将客户端连接到公司网络，但当流量离开公司网络以访问服务时，仍需以其 SRTP 形式流动。</span><span class="sxs-lookup"><span data-stu-id="64cd6-260">It is worth noting that even though a VPN tunnel may be used to connect the client to the corporate network, the traffic still needs to flow in its SRTP form when it leaves the corporate network to reach the service.</span></span>

<span data-ttu-id="64cd6-261">有关解决方案Teams消除常见安全问题的信息，如 _NAT (STUN)_ 放大攻击的语音或会话遍历实用程序，请参阅 [5.1 Security Considerations for Implementers](/openspecs/office_protocols/ms-ice2/69525351-8c68-4864-b8a6-04bfbc87785c)。</span><span class="sxs-lookup"><span data-stu-id="64cd6-261">Information on how Teams mitigates common security concerns such as voice or _Session Traversal Utilities for NAT (STUN)_ amplification attacks can be found in [5.1 Security Considerations for Implementers](/openspecs/office_protocols/ms-ice2/69525351-8c68-4864-b8a6-04bfbc87785c).</span></span>

<span data-ttu-id="64cd6-262">还可以阅读有关远程工作场景中的新式安全控制：[安全专业人员和 IT 人员在当前独特的远程工作场景中实现新式安全控制的替代方法（Microsoft 安全团队博客）](https://www.microsoft.com/security/blog/2020/03/26/alternative-security-professionals-it-achieve-modern-security-controls-todays-unique-remote-work-scenarios/)</span><span class="sxs-lookup"><span data-stu-id="64cd6-262">You can also read about modern security controls in remote work scenarios at [Alternative ways for security professionals and IT to achieve modern security controls in today's unique remote work scenarios (Microsoft Security Team blog)](https://www.microsoft.com/security/blog/2020/03/26/alternative-security-professionals-it-achieve-modern-security-controls-todays-unique-remote-work-scenarios/).</span></span>

## <a name="testing"></a><span data-ttu-id="64cd6-263">测试</span><span class="sxs-lookup"><span data-stu-id="64cd6-263">Testing</span></span>

<span data-ttu-id="64cd6-264">策略准备就绪后，应确认其是否按预期工作。</span><span class="sxs-lookup"><span data-stu-id="64cd6-264">Once the policy is in place, you should confirm it is working as expected.</span></span> <span data-ttu-id="64cd6-265">可通过多种方法来测试路径是否已正确设置为使用本地 Internet 连接：</span><span class="sxs-lookup"><span data-stu-id="64cd6-265">There are multiple ways of testing the path is correctly set to use the local Internet connection:</span></span>

- <span data-ttu-id="64cd6-266">运行Microsoft 365[连接](https://aka.ms/netonboard)测试，该测试将针对您运行连接测试，包括如上所述的跟踪路由。</span><span class="sxs-lookup"><span data-stu-id="64cd6-266">Run the [Microsoft 365 connectivity test](https://aka.ms/netonboard) that will run connectivity tests for you including trace routes as above.</span></span> <span data-ttu-id="64cd6-267">我们还将 VPN 测试添加到此工具中，这还应提供其他见解。</span><span class="sxs-lookup"><span data-stu-id="64cd6-267">We're also adding in VPN tests into this tooling that should also provide additional insights.</span></span>

- <span data-ttu-id="64cd6-268">对于拆分隧道范围内的终结点的简单 tracert，应显示所采用的路径，例如：</span><span class="sxs-lookup"><span data-stu-id="64cd6-268">A simple tracert to an endpoint within scope of the split tunnel should show the path taken, for example:</span></span>

  ```powershell
  tracert worldaz.tr.teams.microsoft.com
  ```

  <span data-ttu-id="64cd6-269">然后，应看到通过本地 ISP 到此终结点的路径，该路径应解析为为拆分隧道Teams配置的范围中的 IP。</span><span class="sxs-lookup"><span data-stu-id="64cd6-269">You should then see a path via the local ISP to this endpoint that should resolve to an IP in the Teams ranges we have configured for split tunneling.</span></span>

- <span data-ttu-id="64cd6-270">以使用 Wireshark 之类的工具进行网络捕获为例。</span><span class="sxs-lookup"><span data-stu-id="64cd6-270">Take a network capture using a tool such as Wireshark.</span></span> <span data-ttu-id="64cd6-271">在呼叫期间筛选 UDP，应看到流量流向 Teams **优化** 范围中的 IP。</span><span class="sxs-lookup"><span data-stu-id="64cd6-271">Filter on UDP during a call and you should see traffic flowing to an IP in the Teams **Optimize** range.</span></span> <span data-ttu-id="64cd6-272">如果 VPN 隧道正用于此流量，则跟踪中将不会显示媒体流量。</span><span class="sxs-lookup"><span data-stu-id="64cd6-272">If the VPN tunnel is being used for this traffic, then the media traffic will not be visible in the trace.</span></span>

### <a name="additional-support-logs"></a><span data-ttu-id="64cd6-273">其他支持日志</span><span class="sxs-lookup"><span data-stu-id="64cd6-273">Additional support logs</span></span>

<span data-ttu-id="64cd6-274">如果需要更多数据来排除故障，或正在请求 Microsoft 支持部门的协助，获取以下信息可帮助你加快查找解决方案。</span><span class="sxs-lookup"><span data-stu-id="64cd6-274">If you need further data to troubleshoot, or are requesting assistance from Microsoft support, obtaining the following information should allow you to expedite finding a solution.</span></span> <span data-ttu-id="64cd6-275">Microsoft 支持的 **TSS Windows基于 CMD 的通用 TroubleShooting 脚本** 工具集可帮助您以一种简单的方式收集相关日志。</span><span class="sxs-lookup"><span data-stu-id="64cd6-275">Microsoft support's **TSS Windows CMD-based universal TroubleShooting Script toolset** can help you to collect the relevant logs in a simple manner.</span></span> <span data-ttu-id="64cd6-276">可在以下网址找到所使用的工具和说明：<https://aka.ms/TssTools.></span><span class="sxs-lookup"><span data-stu-id="64cd6-276">The tool and instructions on use can be found at <https://aka.ms/TssTools.></span></span>

## <a name="howto-guides-for-common-vpn-platforms"></a><span data-ttu-id="64cd6-277">适用于常见 VPN 平台的操作指南</span><span class="sxs-lookup"><span data-stu-id="64cd6-277">HOWTO guides for common VPN platforms</span></span>

<span data-ttu-id="64cd6-278">本节提供了一些链接，这些链接提供了实现 Office 365 流量（来自该领域中最常见的合作伙伴）的拆分隧道的详细指南。</span><span class="sxs-lookup"><span data-stu-id="64cd6-278">This section provides links to detailed guides for implementing split tunneling for Office 365 traffic from the most common partners in this space.</span></span> <span data-ttu-id="64cd6-279">我们将在其他指南推出时添加这些指南。</span><span class="sxs-lookup"><span data-stu-id="64cd6-279">We'll add additional guides as they become available.</span></span>

- <span data-ttu-id="64cd6-280">**Windows 10 VPN 客户端**：[使用本机 Windows 10 VPN 客户端优化面向远程工作者的 Office 365 流量](/windows/security/identity-protection/vpn/vpn-office-365-optimization)</span><span class="sxs-lookup"><span data-stu-id="64cd6-280">**Windows 10 VPN client**: [Optimizing Office 365 traffic for remote workers with the native Windows 10 VPN client](/windows/security/identity-protection/vpn/vpn-office-365-optimization)</span></span>
- <span data-ttu-id="64cd6-281">**Cisco Anyconnect**：[优化 Office365 的 Anyconnect 拆分隧道](https://www.cisco.com/c/en/us/support/docs/security/anyconnect-secure-mobility-client/215343-optimize-anyconnect-split-tunnel-for-off.html)</span><span class="sxs-lookup"><span data-stu-id="64cd6-281">**Cisco Anyconnect**: [Optimize Anyconnect Split Tunnel for Office365](https://www.cisco.com/c/en/us/support/docs/security/anyconnect-secure-mobility-client/215343-optimize-anyconnect-split-tunnel-for-off.html)</span></span>
- <span data-ttu-id="64cd6-282">**Palo Alto GlobalProtect**：[通过 VPN 拆分隧道排除访问路由优化 Office 365 流量](https://live.paloaltonetworks.com/t5/Prisma-Access-Articles/GlobalProtect-Optimizing-Office-365-Traffic/ta-p/319669)</span><span class="sxs-lookup"><span data-stu-id="64cd6-282">**Palo Alto GlobalProtect**: [Optimizing Office 365 Traffic via VPN Split Tunnel Exclude Access Route](https://live.paloaltonetworks.com/t5/Prisma-Access-Articles/GlobalProtect-Optimizing-Office-365-Traffic/ta-p/319669)</span></span>
- <span data-ttu-id="64cd6-283">**F5 Networks BIG-IP APM**：[使用 BIG-IP APM 通过 VPN 优化远程访问 Office 365 流量](https://devcentral.f5.com/s/articles/SSL-VPN-Split-Tunneling-and-Office-365)</span><span class="sxs-lookup"><span data-stu-id="64cd6-283">**F5 Networks BIG-IP APM**: [Optimizing Office 365 traffic on Remote Access through VPNs when using BIG-IP APM](https://devcentral.f5.com/s/articles/SSL-VPN-Split-Tunneling-and-Office-365)</span></span>
- <span data-ttu-id="64cd6-284">**Citrix 网关**：[优化 Office365 Citrix 网关 VPN 拆分隧道](https://docs.citrix.com/en-us/citrix-gateway/13/optimizing-citrix-gateway-vpn-split-tunnel-for-office365.html)</span><span class="sxs-lookup"><span data-stu-id="64cd6-284">**Citrix Gateway**: [Optimizing Citrix Gateway VPN split tunnel for Office365](https://docs.citrix.com/en-us/citrix-gateway/13/optimizing-citrix-gateway-vpn-split-tunnel-for-office365.html)</span></span>
- <span data-ttu-id="64cd6-285">**Pulse Secure**：[VPN 隧道：如何配置拆分隧道以排除 Office365 应用程序](https://kb.pulsesecure.net/articles/Pulse_Secure_Article/KB44417)</span><span class="sxs-lookup"><span data-stu-id="64cd6-285">**Pulse Secure**: [VPN Tunneling: How to configure split tunneling to exclude Office365 applications](https://kb.pulsesecure.net/articles/Pulse_Secure_Article/KB44417)</span></span>
- <span data-ttu-id="64cd6-286">**检查点** [VPN：如何为 Tunnel 和其他 SaaS Office 365配置拆分服务器](https://supportcenter.checkpoint.com/supportcenter/portal?eventSubmit_doGoviewsolutiondetails=&solutionid=sk167000)</span><span class="sxs-lookup"><span data-stu-id="64cd6-286">**Check Point VPN**: [How to configure Split Tunnel for Office 365 and other SaaS Applications](https://supportcenter.checkpoint.com/supportcenter/portal?eventSubmit_doGoviewsolutiondetails=&solutionid=sk167000)</span></span>

## <a name="faq"></a><span data-ttu-id="64cd6-287">常见问题</span><span class="sxs-lookup"><span data-stu-id="64cd6-287">FAQ</span></span>

<span data-ttu-id="64cd6-288">Microsoft 安全团队 [发布了一篇文章](https://www.microsoft.com/security/blog/2020/03/26/alternative-security-professionals-it-achieve-modern-security-controls-todays-unique-remote-work-scenarios/) ，概述了安全专业人员和 IT 人员在当今独特的远程工作场景中实现新式安全控制的关键方法。</span><span class="sxs-lookup"><span data-stu-id="64cd6-288">The Microsoft Security Team has published [an article](https://www.microsoft.com/security/blog/2020/03/26/alternative-security-professionals-it-achieve-modern-security-controls-todays-unique-remote-work-scenarios/) that outlines key ways for security professionals and IT can achieve modern security controls in today's unique remote work scenarios.</span></span> <span data-ttu-id="64cd6-289">此外，下面是有关此主题的一些常见客户问题和解答。</span><span class="sxs-lookup"><span data-stu-id="64cd6-289">In addition, below are some of the common customer questions and answers on this subject.</span></span>

### <a name="how-do-i-stop-users-accessing-other-tenants-i-do-not-trust-where-they-could-exfiltrate-data"></a><span data-ttu-id="64cd6-290">我如何阻止用户访问我不信任的其他租户（他们可能会泄漏数据）？</span><span class="sxs-lookup"><span data-stu-id="64cd6-290">How do I stop users accessing other tenants I do not trust where they could exfiltrate data?</span></span>

<span data-ttu-id="64cd6-291">答案是[称为租户限制的功能](/azure/active-directory/manage-apps/tenant-restrictions)。</span><span class="sxs-lookup"><span data-stu-id="64cd6-291">The answer is a [feature called tenant restrictions](/azure/active-directory/manage-apps/tenant-restrictions).</span></span> <span data-ttu-id="64cd6-292">身份验证流量不大，对延迟也不是特别敏感，因此可通过 VPN 解决方案发送到应用此功能的本地代理。</span><span class="sxs-lookup"><span data-stu-id="64cd6-292">Authentication traffic is not high volume nor especially latency sensitive so can be sent through the VPN solution to the on-premises proxy where the feature is applied.</span></span> <span data-ttu-id="64cd6-293">此处维护受信任租户的允许列表，如果客户端尝试获取到不受信任的租户的令牌，代理只会拒绝请求。</span><span class="sxs-lookup"><span data-stu-id="64cd6-293">An allow list of trusted tenants is maintained here and if the client attempts to obtain a token to a tenant that is not trusted, the proxy simply denies the request.</span></span> <span data-ttu-id="64cd6-294">如果租户受信任，则在用户具有正确的凭据和权限的情况下，令牌可供访问。</span><span class="sxs-lookup"><span data-stu-id="64cd6-294">If the tenant is trusted, then a token is accessible if the user has the right credentials and rights.</span></span>

<span data-ttu-id="64cd6-295">因此，即使用户可以建立与上述"优化"标记的终结点的 TCP/UDP 连接，但没有有效的令牌来访问有关租户，他们也无法登录和访问/移动任何数据。</span><span class="sxs-lookup"><span data-stu-id="64cd6-295">So even though a user can make a TCP/UDP connection to the Optimize marked endpoints above, without a valid token to access the tenant in question, they simply cannot log in and access/move any data.</span></span>

### <a name="does-this-model-allow-access-to-consumer-services-such-as-personal-onedrive-accounts"></a><span data-ttu-id="64cd6-296">此模型是否允许访问诸如个人 OneDrive 帐户之类的使用者服务？</span><span class="sxs-lookup"><span data-stu-id="64cd6-296">Does this model allow access to consumer services such as personal OneDrive accounts?</span></span>

<span data-ttu-id="64cd6-297">否，Office 365 终结点不同于使用者服务（以 Onedrive.live.com 为例），因此拆分隧道将不允许用户直接访问使用者服务。</span><span class="sxs-lookup"><span data-stu-id="64cd6-297">No, it does not, the Office 365 endpoints are not the same as the consumer services (Onedrive.live.com as an example) so the split tunnel will not allow a user to directly access consumer services.</span></span> <span data-ttu-id="64cd6-298">流向使用方终结点的流量将继续使用 VPN 隧道，并且现有策略将继续生效。</span><span class="sxs-lookup"><span data-stu-id="64cd6-298">Traffic to consumer endpoints will continue to use the VPN tunnel and existing policies will continue to apply.</span></span>

### <a name="how-do-i-apply-dlp-and-protect-my-sensitive-data-when-the-traffic-no-longer-flows-through-my-on-premises-solution"></a><span data-ttu-id="64cd6-299">如果流量不再流经本地解决方案，我该如何应用 DLP 并保护我的敏感数据？</span><span class="sxs-lookup"><span data-stu-id="64cd6-299">How do I apply DLP and protect my sensitive data when the traffic no longer flows through my on-premises solution?</span></span>

<span data-ttu-id="64cd6-300">为帮助防止意外泄露敏感信息，Office 365 提供了一组丰富的[内置工具](../compliance/information-protection.md)。</span><span class="sxs-lookup"><span data-stu-id="64cd6-300">To help you prevent the accidental disclosure of sensitive information, Office 365 has a rich set of [built-in tools](../compliance/information-protection.md).</span></span> <span data-ttu-id="64cd6-301">可使用 Teams 和 SharePoint 的内置 [DLP 功能](../compliance/dlp-learn-about-dlp.md)来检测未恰当存储或共享的敏感信息。</span><span class="sxs-lookup"><span data-stu-id="64cd6-301">You can use the built-in [DLP capabilities](../compliance/dlp-learn-about-dlp.md) of Teams and SharePoint to detect inappropriately stored or shared sensitive information.</span></span> <span data-ttu-id="64cd6-302">如果远程工作策略的一部分涉及自带设备办公 (BYOD) 策略，可以使用基于应用的条件访问来防止敏感数据下载到用户[](/azure/active-directory/conditional-access/app-based-conditional-access)的个人设备</span><span class="sxs-lookup"><span data-stu-id="64cd6-302">If part of your remote work strategy involves a bring-your-own-device (BYOD) policy, you can use [app-based Conditional Access](/azure/active-directory/conditional-access/app-based-conditional-access) to prevent sensitive data from being downloaded to users' personal devices</span></span>

### <a name="how-do-i-evaluate-and-maintain-control-of-the-users-authentication-when-they-are-connecting-directly"></a><span data-ttu-id="64cd6-303">如何在用户直接连接时评估和保留用户身份验证的控制权？</span><span class="sxs-lookup"><span data-stu-id="64cd6-303">How do I evaluate and maintain control of the user's authentication when they are connecting directly?</span></span>

<span data-ttu-id="64cd6-304">除了问题 1 中提到的租户限制功能之外，还可以应用[条件访问策略](/azure/active-directory/conditional-access/overview)来动态评估身份验证请求的风险并做出相应的反应。</span><span class="sxs-lookup"><span data-stu-id="64cd6-304">In addition to the tenant restrictions feature noted in Q1, [conditional access policies](/azure/active-directory/conditional-access/overview) can be applied to dynamically assess the risk of an authentication request and react appropriately.</span></span> <span data-ttu-id="64cd6-305">Microsoft 建议在一段时间内实现[零信任模型](https://www.microsoft.com/security/zero-trust?rtc=1)，我们可以使用 Azure AD 条件访问策略在移动和以云为中心的世界保持控制。</span><span class="sxs-lookup"><span data-stu-id="64cd6-305">Microsoft recommends the [Zero Trust model](https://www.microsoft.com/security/zero-trust?rtc=1) is implemented over time and we can use Azure AD conditional access policies to maintain control in a mobile and cloud first world.</span></span> <span data-ttu-id="64cd6-306">可使用条件访问策略对身份验证请求是否成功作出实时决策，具体取决于以下诸多因素：</span><span class="sxs-lookup"><span data-stu-id="64cd6-306">Conditional access policies can be used to make a real-time decision on whether an authentication request is successful based on numerous factors such as:</span></span>

- <span data-ttu-id="64cd6-307">设备，设备是否已知/受信任/已加入域？</span><span class="sxs-lookup"><span data-stu-id="64cd6-307">Device, is the device known/trusted/Domain joined?</span></span>
- <span data-ttu-id="64cd6-308">IP – 身份验证请求是否来自已知公司 IP 地址？</span><span class="sxs-lookup"><span data-stu-id="64cd6-308">IP – is the authentication request coming from a known corporate IP address?</span></span> <span data-ttu-id="64cd6-309">或者来自不信任的国家/地区？</span><span class="sxs-lookup"><span data-stu-id="64cd6-309">Or from a country we do not trust?</span></span>
- <span data-ttu-id="64cd6-310">应用程序 – 用户是否有权使用此应用程序？</span><span class="sxs-lookup"><span data-stu-id="64cd6-310">Application – Is the user authorized to use this application?</span></span>

<span data-ttu-id="64cd6-311">然后，我们可以根据这些策略触发批准、触发 MFA 或阻止身份验证等策略。</span><span class="sxs-lookup"><span data-stu-id="64cd6-311">We can then trigger policy such as approve, trigger MFA or block authentication based on these policies.</span></span>

### <a name="how-do-i-protect-against-viruses-and-malware"></a><span data-ttu-id="64cd6-312">如何防范病毒和恶意软件？</span><span class="sxs-lookup"><span data-stu-id="64cd6-312">How do I protect against viruses and malware?</span></span>

<span data-ttu-id="64cd6-313">同样，Office 365 为服务自身各层中标记为“优化”的终结点提供了保护，[本文档对此进行了概述](/office365/Enterprise/office-365-malware-and-ransomware-protection)。</span><span class="sxs-lookup"><span data-stu-id="64cd6-313">Again, Office 365 provides protection for the Optimize marked endpoints in various layers in the service itself, [outlined in this document](/office365/Enterprise/office-365-malware-and-ransomware-protection).</span></span> <span data-ttu-id="64cd6-314">如前所述，在服务本身中提供这些安全元素，而不是尝试在可能完全了解协议/流量的设备中这样做会更有效。默认情况下，SharePoint Online[自动扫描文件上传中的](../security/office-365-security/virus-detection-in-spo.md)已知恶意软件</span><span class="sxs-lookup"><span data-stu-id="64cd6-314">As noted, it is vastly more efficient to provide these security elements in the service itself rather than try to do it in line with devices that may not fully understand the protocols/traffic.By default, SharePoint Online [automatically scans file uploads](../security/office-365-security/virus-detection-in-spo.md) for known malware</span></span>

<span data-ttu-id="64cd6-315">对于上面Exchange的终结点，Exchange Online Protection和 Microsoft [](/office365/servicedescriptions/exchange-online-protection-service-description/exchange-online-protection-service-description) Defender for [Office 365](/office365/servicedescriptions/office-365-advanced-threat-protection-service-description)可以出色地为服务提供流量安全。</span><span class="sxs-lookup"><span data-stu-id="64cd6-315">For the Exchange endpoints listed above, [Exchange Online Protection](/office365/servicedescriptions/exchange-online-protection-service-description/exchange-online-protection-service-description) and [Microsoft Defender for Office 365](/office365/servicedescriptions/office-365-advanced-threat-protection-service-description) do an excellent job of providing security of the traffic to the service.</span></span>

### <a name="can-i-send-more-than-just-the-optimize-traffic-direct"></a><span data-ttu-id="64cd6-316">除了优化流量外，我是否可以直接发送更多流量？</span><span class="sxs-lookup"><span data-stu-id="64cd6-316">Can I send more than just the Optimize traffic direct?</span></span>

<span data-ttu-id="64cd6-317">应优先考虑标记为 **优化** 的终结点，因为这些终结点将为低级别的工作提供最大好处。</span><span class="sxs-lookup"><span data-stu-id="64cd6-317">Priority should be given to the **Optimize** marked endpoints as these will give maximum benefit for a low level of work.</span></span> <span data-ttu-id="64cd6-318">但是，如果需要，服务需要"允许标记的终结点"才能工作，并拥有为在必要时可以使用的终结点提供的 IP 地址。</span><span class="sxs-lookup"><span data-stu-id="64cd6-318">However, if you wish, the Allow marked endpoints are required for the service to work and have IP addresses provided for the endpoints that can be used if necessary.</span></span>

<span data-ttu-id="64cd6-319">此外，还有各种供应商提供基于云的代理/安全解决方案，称为安全 _Web_ 网关，可提供用于常规 Web 浏览的中心安全、控制和公司策略应用程序。</span><span class="sxs-lookup"><span data-stu-id="64cd6-319">There are also various vendors who offer cloud-based proxy/security solutions called _secure web gateways_ which provide central security, control, and corporate policy application for general web browsing.</span></span> <span data-ttu-id="64cd6-320">这些解决方案在云第一世界（如果高度可用、性能高且预配接近用户）中可以正常工作，通过允许从靠近用户的基于云的位置提供安全 Internet 访问。</span><span class="sxs-lookup"><span data-stu-id="64cd6-320">These solutions can work well in a cloud first world, if highly available, performant, and provisioned close to your users by allowing secure Internet access to be delivered from a cloud-based location close to the user.</span></span> <span data-ttu-id="64cd6-321">这将消除通过 VPN/公司网络执行回流以便正常浏览流量的需要，同时仍允许中央安全控制。</span><span class="sxs-lookup"><span data-stu-id="64cd6-321">This removes the need for a hairpin through the VPN/corporate network for general browsing traffic, whilst still allowing central security control.</span></span>

<span data-ttu-id="64cd6-322">然而，即使就地使用这些解决方案，Microsoft 仍强烈建议将标记为“优化”的 Office 365 流量直接发送到服务。</span><span class="sxs-lookup"><span data-stu-id="64cd6-322">Even with these solutions in place however, Microsoft still strongly recommends that Optimize marked Office 365 traffic is sent direct to the service.</span></span>

<span data-ttu-id="64cd6-323">有关允许直接访问 Azure 虚拟网络的指南，请参阅[使用 Azure VPN 网关点到站点进行远程工作](/azure/vpn-gateway/work-remotely-support)一文。</span><span class="sxs-lookup"><span data-stu-id="64cd6-323">For guidance on allowing direct access to an Azure Virtual Network, see the article [Remote work using Azure VPN Gateway Point-to-site](/azure/vpn-gateway/work-remotely-support).</span></span>

### <a name="why-is-port-80-required-is-traffic-sent-in-the-clear"></a><span data-ttu-id="64cd6-324">为什么需要端口 80？</span><span class="sxs-lookup"><span data-stu-id="64cd6-324">Why is port 80 required?</span></span> <span data-ttu-id="64cd6-325">流量是否明文发送？</span><span class="sxs-lookup"><span data-stu-id="64cd6-325">Is traffic sent in the clear?</span></span>

<span data-ttu-id="64cd6-326">端口 80 仅用于重定向到端口 443 会话之类的操作，不会通过端口 80 发送或访问任何客户数据。</span><span class="sxs-lookup"><span data-stu-id="64cd6-326">Port 80 is only used for things like redirect to a port 443 session, no customer data is sent or is accessible over port 80.</span></span> <span data-ttu-id="64cd6-327">[加密](../compliance/encryption.md)概述了对传输中和静态数据进行加密Office 365流量类型概述了如何使用 SRTP 来保护Teams流量。 [](/microsoftteams/microsoft-teams-online-call-flows#types-of-traffic)</span><span class="sxs-lookup"><span data-stu-id="64cd6-327">[Encryption](../compliance/encryption.md) outlines encryption for data in transit and at rest for Office 365, and [Types of traffic](/microsoftteams/microsoft-teams-online-call-flows#types-of-traffic) outlines how we use SRTP to protect Teams media traffic.</span></span>

### <a name="does-this-advice-apply-to-users-in-china-using-a-worldwide-instance-of-office-365"></a><span data-ttu-id="64cd6-328">此建议是否适用于使用 Office 365 全球实例的中国用户？</span><span class="sxs-lookup"><span data-stu-id="64cd6-328">Does this advice apply to users in China using a worldwide instance of Office 365?</span></span>

<span data-ttu-id="64cd6-329">**否**，不适用。</span><span class="sxs-lookup"><span data-stu-id="64cd6-329">**No**, it does not.</span></span> <span data-ttu-id="64cd6-330">在上述建议中，要注意连接到 Office 365 全球实例的中国用户。</span><span class="sxs-lookup"><span data-stu-id="64cd6-330">The one caveat to the above advice is users in the PRC who are connecting to a worldwide instance of Office 365.</span></span> <span data-ttu-id="64cd6-331">由于该区域会经常出现跨境网络拥挤现象，因此直接 Internet 出口性能可能会有变化。</span><span class="sxs-lookup"><span data-stu-id="64cd6-331">Due to the common occurrence of cross border network congestion in the region, direct Internet egress performance can be variable.</span></span> <span data-ttu-id="64cd6-332">该区域中的大多数客户都使用 VPN 将流量引入公司网络，并利用其经授权的 MPLS 专线或类似于通过优化路径的国家/地区之外的出口。</span><span class="sxs-lookup"><span data-stu-id="64cd6-332">Most customers in the region operate using a VPN to bring the traffic into the corporate network and utilize their authorized MPLS circuit or similar to egress outside the country via an optimized path.</span></span> <span data-ttu-id="64cd6-333">[面向中国用户的 Office 365 性能优化](microsoft-365-networking-china.md)一文对此进行了进一步的概述。</span><span class="sxs-lookup"><span data-stu-id="64cd6-333">This is outlined further in the article [Office 365 performance optimization for China users](microsoft-365-networking-china.md).</span></span>

### <a name="does-split-tunnel-configuration-work-for-teams-running-in-a-browser"></a><span data-ttu-id="64cd6-334">拆分隧道配置是否适用于在Teams中运行的信息？</span><span class="sxs-lookup"><span data-stu-id="64cd6-334">Does split-tunnel configuration work for Teams running in a browser?</span></span>

<span data-ttu-id="64cd6-335">是的，它通过支持的浏览器（在获取客户端 for [Microsoft Teams 中列出](https://docs.microsoft.com/microsoftteams/get-clients#web-client)）。</span><span class="sxs-lookup"><span data-stu-id="64cd6-335">Yes it does, via supported browsers, which are listed in [Get clients for Microsoft Teams](https://docs.microsoft.com/microsoftteams/get-clients#web-client).</span></span>

## <a name="related-topics"></a><span data-ttu-id="64cd6-336">相关主题</span><span class="sxs-lookup"><span data-stu-id="64cd6-336">Related topics</span></span>

[<span data-ttu-id="64cd6-337">概述：Office 365 的 VPN 拆分隧道</span><span class="sxs-lookup"><span data-stu-id="64cd6-337">Overview: VPN split tunneling for Office 365</span></span>](microsoft-365-vpn-split-tunnel.md)

[<span data-ttu-id="64cd6-338">面向中国用户的 Office 365 性能优化</span><span class="sxs-lookup"><span data-stu-id="64cd6-338">Office 365 performance optimization for China users</span></span>](microsoft-365-networking-china.md)

[<span data-ttu-id="64cd6-339">安全专业人员和 IT 人员在当前独特的远程工作场景中实现新式安全控制的替代方法（Microsoft 安全团队博客）</span><span class="sxs-lookup"><span data-stu-id="64cd6-339">Alternative ways for security professionals and IT to achieve modern security controls in today's unique remote work scenarios (Microsoft Security Team blog)</span></span>](https://www.microsoft.com/security/blog/2020/03/26/alternative-security-professionals-it-achieve-modern-security-controls-todays-unique-remote-work-scenarios/)

[<span data-ttu-id="64cd6-340">增强 Microsoft 的 VPN 性能：使用 Windows 10 VPN 配置文件以允许自动打开连接</span><span class="sxs-lookup"><span data-stu-id="64cd6-340">Enhancing VPN performance at Microsoft: using Windows 10 VPN profiles to allow auto-on connections</span></span>](https://www.microsoft.com/itshowcase/enhancing-remote-access-in-windows-10-with-an-automatic-vpn-profile)

[<span data-ttu-id="64cd6-341">运行 VPN：Microsoft 如何让远程工作人员互联</span><span class="sxs-lookup"><span data-stu-id="64cd6-341">Running on VPN: How Microsoft is keeping its remote workforce connected</span></span>](https://www.microsoft.com/itshowcase/blog/running-on-vpn-how-microsoft-is-keeping-its-remote-workforce-connected/?elevate-lv)

[<span data-ttu-id="64cd6-342">Office 365 网络连接原则</span><span class="sxs-lookup"><span data-stu-id="64cd6-342">Office 365 Network Connectivity Principles</span></span>](microsoft-365-network-connectivity-principles.md)

[<span data-ttu-id="64cd6-343">评估 Office 365 网络连接</span><span class="sxs-lookup"><span data-stu-id="64cd6-343">Assessing Office 365 network connectivity</span></span>](assessing-network-connectivity.md)

[<span data-ttu-id="64cd6-344">Office 365 网络和性能优化</span><span class="sxs-lookup"><span data-stu-id="64cd6-344">Office 365 network and performance tuning</span></span>](network-planning-and-performance.md)
