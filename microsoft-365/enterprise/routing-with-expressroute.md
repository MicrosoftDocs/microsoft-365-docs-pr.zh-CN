---
title: 通过适用于 Office 365 的 ExpressRoute 进行路由
ms.author: kvice
author: kelleyvice-msft
manager: laurawi
ms.date: 12/3/2019
audience: ITPro
ms.topic: conceptual
ms.service: o365-administration
localization_priority: Normal
ms.collection:
- Ent_O365
- Strat_O365_Enterprise
f1.keywords:
- CSH
ms.custom:
- Adm_O365
- seo-marvel-apr2020
search.appverid:
- MET150
- MOE150
- BCS160
ms.assetid: e1da26c6-2d39-4379-af6f-4da213218408
description: 本文介绍与 Office 365 一同使用的 Azure ExpressRoute 路由要求、电路和路由域。
ms.openlocfilehash: b455ed7e53b3018babb1abd58919a077fb9d0685
ms.sourcegitcommit: 3fe7eb32c8d6e01e190b2b782827fbadd73a18e6
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/13/2021
ms.locfileid: "51687165"
---
# <a name="routing-with-expressroute-for-office-365"></a><span data-ttu-id="86338-103">通过适用于 Office 365 的 ExpressRoute 进行路由</span><span class="sxs-lookup"><span data-stu-id="86338-103">Routing with ExpressRoute for Office 365</span></span>

<span data-ttu-id="86338-104">*此文章适用于 Microsoft 365 企业版和 Office 365 企业版。* </span><span class="sxs-lookup"><span data-stu-id="86338-104">*This article applies to both Microsoft 365 Enterprise and Office 365 Enterprise.*</span></span>

<span data-ttu-id="86338-105">若要正确了解使用 Azure ExpressRoute 将流量路由到 Office 365，你需要掌握核心 [ExpressRoute](/azure/expressroute/expressroute-routing) 路由要求以及 [ExpressRoute 电路和路由域](/azure/expressroute/expressroute-circuit-peerings)。</span><span class="sxs-lookup"><span data-stu-id="86338-105">To properly understand routing traffic to Office 365 using Azure ExpressRoute, you'll need a firm grasp of the core [ExpressRoute routing requirements](/azure/expressroute/expressroute-routing) and the [ExpressRoute circuits and routing domains](/azure/expressroute/expressroute-circuit-peerings).</span></span> <span data-ttu-id="86338-106">其中规定了使用 Office 365 客户将依赖的 ExpressRoute 的基本信息。</span><span class="sxs-lookup"><span data-stu-id="86338-106">These lay out the fundamentals for using ExpressRoute that Office 365 customers will rely on.</span></span>
  
<span data-ttu-id="86338-107">您需要了解的上述文章中的一些关键项包括：</span><span class="sxs-lookup"><span data-stu-id="86338-107">Some of the key items in the above articles that you'll need to understand include:</span></span>
  
- <span data-ttu-id="86338-108">ExpressRoute 电路不会映射到特定的物理基础结构，而是 Microsoft 和对等提供商代表你在单个对等位置建立的逻辑连接。</span><span class="sxs-lookup"><span data-stu-id="86338-108">ExpressRoute circuits aren't mapped to specific physical infrastructure, but are a logical connection made at a single peering location by Microsoft and a peering provider on your behalf.</span></span>

- <span data-ttu-id="86338-109">ExpressRoute 电路和客户密钥之间的映射为 1：1。</span><span class="sxs-lookup"><span data-stu-id="86338-109">There's a 1:1 mapping between an ExpressRoute circuit and a customer s-key.</span></span>

- <span data-ttu-id="86338-110">每个电路可以支持两个独立的对等 (Azure 专用对等和 Microsoft 对等) ;Office 365 需要 Microsoft 对等。</span><span class="sxs-lookup"><span data-stu-id="86338-110">Each circuit can support two independent peering relationships (Azure Private peering, and Microsoft peering); Office 365 requires Microsoft peering.</span></span>

- <span data-ttu-id="86338-111">每个电路都有一个在所有对等关系中共享的固定带宽。</span><span class="sxs-lookup"><span data-stu-id="86338-111">Each circuit has a fixed bandwidth that is shared across all peering relationships.</span></span>

- <span data-ttu-id="86338-112">任何公共 IPv4 地址和用于 ExpressRoute 电路的公共 AS 号码都必须被验证为归你所有，或由地址范围的所有者专门分配给你。</span><span class="sxs-lookup"><span data-stu-id="86338-112">Any public IPv4 addresses and public AS numbers that will be used for the ExpressRoute circuit must be validated as being owned by you, or assigned exclusively to you by the owner of the address range.</span></span>

- <span data-ttu-id="86338-113">虚拟 ExpressRoute 电路是全局冗余的，将遵循标准 BGP 路由做法。</span><span class="sxs-lookup"><span data-stu-id="86338-113">The virtual ExpressRoute circuits are redundant globally and will follow standard BGP routing practices.</span></span> <span data-ttu-id="86338-114">这就是在主动/主动配置中建议每个提供商的两个物理电路的原因。</span><span class="sxs-lookup"><span data-stu-id="86338-114">This is why we recommend two physical circuits per egress to your provider in an active/active configuration.</span></span>

<span data-ttu-id="86338-115">有关受支持的 [服务](/azure/expressroute/expressroute-faqs) 、成本和配置详细信息的详细信息，请参阅常见问题页面。</span><span class="sxs-lookup"><span data-stu-id="86338-115">See the [FAQ page](/azure/expressroute/expressroute-faqs) for more information on services supported, costs, and configuration details.</span></span> <span data-ttu-id="86338-116">有关提供 Microsoft 对等支持的连接提供程序列表的信息，请参阅 [ExpressRoute](/azure/expressroute/expressroute-locations) 位置文章。</span><span class="sxs-lookup"><span data-stu-id="86338-116">See the [ExpressRoute locations article](/azure/expressroute/expressroute-locations) for information on the list of connectivity providers offering Microsoft peering support.</span></span> <span data-ttu-id="86338-117">我们还在 Channel 9 上记录了一个 10 部分 [Azure ExpressRoute for Office 365 培训](https://channel9.msdn.com/series/aer) 系列，以帮助更详尽地解释概念。</span><span class="sxs-lookup"><span data-stu-id="86338-117">We've also recorded a 10-part [Azure ExpressRoute for Office 365 Training](https://channel9.msdn.com/series/aer) series on Channel 9 to help explain the concepts more thoroughly.</span></span>
  
## <a name="ensuring-route-symmetry"></a><span data-ttu-id="86338-118">确保路由对称</span><span class="sxs-lookup"><span data-stu-id="86338-118">Ensuring route symmetry</span></span>

<span data-ttu-id="86338-119">Office 365 前端服务器可通过 Internet 和 ExpressRoute 访问。</span><span class="sxs-lookup"><span data-stu-id="86338-119">The Office 365 front-end servers are accessible on both the Internet and ExpressRoute.</span></span> <span data-ttu-id="86338-120">当两者同时可用时，这些服务器将倾向于通过 ExpressRoute 电路路由回本地。</span><span class="sxs-lookup"><span data-stu-id="86338-120">These servers will prefer to route back to on-premises over ExpressRoute circuits when both are available.</span></span> <span data-ttu-id="86338-121">因此，如果来自网络的流量倾向于通过 Internet 线路进行路由，则可能会进行路线不对称。</span><span class="sxs-lookup"><span data-stu-id="86338-121">Because of this, there is a possibility of route asymmetry if traffic from your network prefers to route over your Internet circuits.</span></span> <span data-ttu-id="86338-122">非对称路由是一个问题，因为执行有状态数据包检查的设备可能会阻止遵循与所关注出站数据包不同的路径的返回流量。</span><span class="sxs-lookup"><span data-stu-id="86338-122">Asymmetrical routes are a problem because devices that perform stateful packet inspection can block return traffic that follows a different path than the outbound packets followed.</span></span>
  
<span data-ttu-id="86338-123">无论通过 Internet 还是 ExpressRoute 启动与 Office 365 的连接，源都必须是可公开路由的地址。</span><span class="sxs-lookup"><span data-stu-id="86338-123">Regardless of whether you initiate a connection to Office 365 over the Internet or ExpressRoute, the source must be a publicly routable address.</span></span> <span data-ttu-id="86338-124">由于许多客户直接与 Microsoft 对等，因此在客户之间可能重复的情况下使用专用地址不可行。</span><span class="sxs-lookup"><span data-stu-id="86338-124">With many customers peering directly with Microsoft, having private addresses where duplication is possible between customers isn't feasible.</span></span>
  
<span data-ttu-id="86338-125">以下方案将启动从 Office 365 到本地网络的通信。</span><span class="sxs-lookup"><span data-stu-id="86338-125">The following are scenarios where communications from Office 365 to your on-premises network will be initiated.</span></span> <span data-ttu-id="86338-126">为了简化网络设计，我们建议通过 Internet 路径路由它们。</span><span class="sxs-lookup"><span data-stu-id="86338-126">To simplify your network design, we recommend routing these over the Internet path.</span></span>
  
- <span data-ttu-id="86338-127">SMTP 服务，例如从 Exchange Online 租户发送到本地主机的邮件，或从 SharePoint Online 发送到本地主机的 SharePoint Online 邮件。</span><span class="sxs-lookup"><span data-stu-id="86338-127">SMTP services such as mail from an Exchange Online tenant to an on-premises host or SharePoint Online Mail sent from SharePoint Online to an on-premises host.</span></span> <span data-ttu-id="86338-128">与通过 ExpressRoute 电路共享的路由前缀和通过 ExpressRoute 在本地 SMTP 服务器上做广告的路由前缀，SMTP 协议在 Microsoft 网络中使用得更为广泛，这些其他服务将导致故障。</span><span class="sxs-lookup"><span data-stu-id="86338-128">SMTP protocol is used more broadly within Microsoft's network than the route prefixes shared over ExpressRoute circuits and advertising on-premises SMTP servers over ExpressRoute will cause failures with these other services.</span></span>

- <span data-ttu-id="86338-129">登录密码验证期间 ADFS。</span><span class="sxs-lookup"><span data-stu-id="86338-129">ADFS during password validation for signing in.</span></span>

- <span data-ttu-id="86338-130">[Exchange Server混合部署](/exchange/exchange-hybrid)。</span><span class="sxs-lookup"><span data-stu-id="86338-130">[Exchange Server Hybrid deployments](/exchange/exchange-hybrid).</span></span>

- <span data-ttu-id="86338-131">[SharePoint 联合混合搜索](/SharePoint/hybrid/display-hybrid-federated-search-results-in-sharepoint-online)。</span><span class="sxs-lookup"><span data-stu-id="86338-131">[SharePoint federated hybrid search](/SharePoint/hybrid/display-hybrid-federated-search-results-in-sharepoint-online).</span></span>

- <span data-ttu-id="86338-132">[SharePoint 混合BCS](/SharePoint/hybrid/deploy-a-business-connectivity-services-hybrid-solution)。</span><span class="sxs-lookup"><span data-stu-id="86338-132">[SharePoint hybrid BCS](/SharePoint/hybrid/deploy-a-business-connectivity-services-hybrid-solution).</span></span>

- <span data-ttu-id="86338-133">[Skype for Business 混合](/skypeforbusiness/hybrid/plan-hybrid-connectivity?bc=%2fSkypeForBusiness%2fbreadcrumb%2ftoc.json&toc=%2fSkypeForBusiness%2ftoc.json) 和/或 [Skype for Business 联盟](/office365/servicedescriptions/skype-for-business-online-service-description/skype-for-business-online-features)。</span><span class="sxs-lookup"><span data-stu-id="86338-133">[Skype for Business hybrid](/skypeforbusiness/hybrid/plan-hybrid-connectivity?bc=%2fSkypeForBusiness%2fbreadcrumb%2ftoc.json&toc=%2fSkypeForBusiness%2ftoc.json) and/or [Skype for Business federation](/office365/servicedescriptions/skype-for-business-online-service-description/skype-for-business-online-features).</span></span>

- <span data-ttu-id="86338-134">[Skype for Business 云连接器](/skypeforbusiness/skype-for-business-hybrid-solutions/plan-your-phone-system-cloud-pbx-solution/plan-skype-for-business-cloud-connector-edition)。</span><span class="sxs-lookup"><span data-stu-id="86338-134">[Skype for Business Cloud Connector](/skypeforbusiness/skype-for-business-hybrid-solutions/plan-your-phone-system-cloud-pbx-solution/plan-skype-for-business-cloud-connector-edition).</span></span>

<span data-ttu-id="86338-135">对于这些双向流量，Microsoft 要路由回网络，到本地设备的 BGP 路由必须与 Microsoft 共享。</span><span class="sxs-lookup"><span data-stu-id="86338-135">For Microsoft to route back to your network for these bi-directional traffic flows, the BGP routes to your on-premises devices must be shared with Microsoft.</span></span> <span data-ttu-id="86338-136">通过 ExpressRoute 向 Microsoft 播发路由前缀时，应遵循以下最佳做法：</span><span class="sxs-lookup"><span data-stu-id="86338-136">When you advertise route prefixes to Microsoft over ExpressRoute, you should follow these best practices:</span></span>

1) <span data-ttu-id="86338-137">不要向公共 Internet 和 ExpressRoute 公布相同的公共 IP 地址路由前缀。</span><span class="sxs-lookup"><span data-stu-id="86338-137">Do not advertise the same public IP Address route prefix to the public Internet and over ExpressRoute.</span></span> <span data-ttu-id="86338-138">建议通过 ExpressRoute 向 Microsoft 发送的 IP BGP 路由前缀广告来自一个完全未向 Internet 播发的范围。</span><span class="sxs-lookup"><span data-stu-id="86338-138">It is recommended that the IP BGP Route Prefix advertisements to Microsoft over ExpressRoute are from a range that is not advertised to the internet at all.</span></span> <span data-ttu-id="86338-139">如果由于可用的 IP 地址空间无法实现此目的，则必须确保通过 ExpressRoute 播发比任何 Internet 线路更具体的范围。</span><span class="sxs-lookup"><span data-stu-id="86338-139">If this is not possible to achieve due to the available IP Address space, then it is essential to ensure you advertise a more specific range over ExpressRoute than any internet circuits.</span></span>

2) <span data-ttu-id="86338-140">每个 ExpressRoute 电路使用单独的 NAT IP 池，并独立于 Internet 线路。</span><span class="sxs-lookup"><span data-stu-id="86338-140">Use separate NAT IP pools per ExpressRoute circuit and separate to that of your internet circuits.</span></span>

3) <span data-ttu-id="86338-141">请注意，向 Microsoft 播发的任何路由都将吸引来自 Microsoft 网络中任何服务器的网络流量，而不仅是通过 ExpressRoute 向网络播发路由的网络流量。</span><span class="sxs-lookup"><span data-stu-id="86338-141">Be aware that any route advertised to Microsoft will attract network traffic from any server in Microsoft's network, not only those for which routes are advertised to your network over ExpressRoute.</span></span> <span data-ttu-id="86338-142">仅向团队定义并理解路由方案的服务器播发路由。</span><span class="sxs-lookup"><span data-stu-id="86338-142">Only advertise routes to servers where routing scenarios are defined and well understood by your team.</span></span> <span data-ttu-id="86338-143">在网络的每个 ExpressRoute 电路上播发单独的 IP 地址路由前缀。</span><span class="sxs-lookup"><span data-stu-id="86338-143">Advertise separate IP Address route prefixes at each of multiple ExpressRoute circuits from your network.</span></span>
  
## <a name="deciding-which-applications-and-features-route-over-expressroute"></a><span data-ttu-id="86338-144">确定通过 ExpressRoute 路由的应用程序和功能</span><span class="sxs-lookup"><span data-stu-id="86338-144">Deciding which applications and features route over ExpressRoute</span></span>

<span data-ttu-id="86338-145">当你使用 Microsoft 对等路由域配置对等关系并经过批准进行适当访问时，你将能够看到通过 ExpressRoute 提供的所有 PaaS 和 SaaS 服务。</span><span class="sxs-lookup"><span data-stu-id="86338-145">When you configure a peering relationship using the Microsoft peering routing domain and are approved for the appropriate access, you'll be able to see all PaaS and SaaS services available over ExpressRoute.</span></span> <span data-ttu-id="86338-146">专为 ExpressRoute 设计的 Office 365 服务可以使用 [BGP](./bgp-communities-in-expressroute.md) 社区或路由 [筛选器进行管理](/azure/expressroute/how-to-routefilter-portal)。</span><span class="sxs-lookup"><span data-stu-id="86338-146">The Office 365 services designed for ExpressRoute can be managed with [BGP communities](./bgp-communities-in-expressroute.md) or [route filters](/azure/expressroute/how-to-routefilter-portal).</span></span>
  
<span data-ttu-id="86338-147">其他应用程序（如 Office 365 视频）是 Office 365 应用程序;但是，Office 365 视频由三个不同的组件组成：门户、流式传输服务和内容交付网络。</span><span class="sxs-lookup"><span data-stu-id="86338-147">Other applications such as Office 365 Video, is an Office 365 application; however, Office 365 Video is comprised of three different components, the portal, the streaming service, and the content delivery network.</span></span> <span data-ttu-id="86338-148">门户位于 SharePoint Online 中，流式服务位于 Azure Media Services 中，内容交付网络位于 Azure CDN 内。</span><span class="sxs-lookup"><span data-stu-id="86338-148">The portal lives within SharePoint Online, the streaming service lives within Azure Media Services, and the content delivery network lives within the Azure CDN.</span></span> <span data-ttu-id="86338-149">下表概述了这些组件。</span><span class="sxs-lookup"><span data-stu-id="86338-149">The following table outlines these components.</span></span>

|<span data-ttu-id="86338-150">**组件**</span><span class="sxs-lookup"><span data-stu-id="86338-150">**Component**</span></span>|<span data-ttu-id="86338-151">**基础应用程序**</span><span class="sxs-lookup"><span data-stu-id="86338-151">**Underlying application**</span></span>|<span data-ttu-id="86338-152">**包含在 SharePoint Online BGP 社区中？**</span><span class="sxs-lookup"><span data-stu-id="86338-152">**Included in SharePoint Online BGP Community?**</span></span>|<span data-ttu-id="86338-153">**使用**</span><span class="sxs-lookup"><span data-stu-id="86338-153">**Use**</span></span>|
|:-----|:-----|:-----|:-----|
|<span data-ttu-id="86338-154">Office 365 视频门户</span><span class="sxs-lookup"><span data-stu-id="86338-154">Office 365 Video portal</span></span>  <br/> |<span data-ttu-id="86338-155">SharePoint Online</span><span class="sxs-lookup"><span data-stu-id="86338-155">SharePoint Online</span></span>  <br/> |<span data-ttu-id="86338-156">是</span><span class="sxs-lookup"><span data-stu-id="86338-156">Yes</span></span>  <br/> |<span data-ttu-id="86338-157">配置、上载</span><span class="sxs-lookup"><span data-stu-id="86338-157">Configuration, upload</span></span>  <br/> |
|<span data-ttu-id="86338-158">Office 365 视频流服务</span><span class="sxs-lookup"><span data-stu-id="86338-158">Office 365 Video streaming service</span></span>  <br/> |<span data-ttu-id="86338-159">Azure 媒体服务</span><span class="sxs-lookup"><span data-stu-id="86338-159">Azure Media Services</span></span>  <br/> |<span data-ttu-id="86338-160">否</span><span class="sxs-lookup"><span data-stu-id="86338-160">No</span></span>  <br/> |<span data-ttu-id="86338-161">流式处理服务，在视频无法从 CDN 访问时使用</span><span class="sxs-lookup"><span data-stu-id="86338-161">Streaming service, used in the event the video is unavailable from the CDN</span></span>  <br/> |
|<span data-ttu-id="86338-162">Office 365 视频内容交付网络</span><span class="sxs-lookup"><span data-stu-id="86338-162">Office 365 Video content delivery network</span></span>  <br/> |<span data-ttu-id="86338-163">Azure CDN</span><span class="sxs-lookup"><span data-stu-id="86338-163">Azure CDN</span></span>  <br/> |<span data-ttu-id="86338-164">否</span><span class="sxs-lookup"><span data-stu-id="86338-164">No</span></span>  <br/> |<span data-ttu-id="86338-165">视频下载/流式传输的主要来源。</span><span class="sxs-lookup"><span data-stu-id="86338-165">Primary source of video download/streaming.</span></span> <span data-ttu-id="86338-166">[详细了解 Office 365 视频网络](https://support.office.com/article/Office-365-Video-networking-Frequently-Asked-Questions-FAQ-2bed67a1-4052-49ff-a4ce-b7e6530eb98e)。</span><span class="sxs-lookup"><span data-stu-id="86338-166">[Learn more about Office 365 video networking](https://support.office.com/article/Office-365-Video-networking-Frequently-Asked-Questions-FAQ-2bed67a1-4052-49ff-a4ce-b7e6530eb98e).</span></span>  <br/> |

<span data-ttu-id="86338-167">Office 365 终结点文章中按应用程序类型和 FQDN 列出了使用 Microsoft 对等的每个 [Office 365](https://support.office.com/article/Office-365-URLs-and-IP-address-ranges-8548a211-3fe7-47cb-abb1-355ea5aa88a2) 功能。</span><span class="sxs-lookup"><span data-stu-id="86338-167">Each of the Office 365 features that are available using Microsoft peering are listed in the [Office 365 endpoints article](https://support.office.com/article/Office-365-URLs-and-IP-address-ranges-8548a211-3fe7-47cb-abb1-355ea5aa88a2) by application type and FQDN.</span></span> <span data-ttu-id="86338-168">使用表中 FQDN 的原因是允许客户使用 PAC 文件或其他代理配置管理流量，请参阅管理 [Office 365](./managing-office-365-endpoints.md) 终结点（例如 PAC 文件）的指南。</span><span class="sxs-lookup"><span data-stu-id="86338-168">The reason for using the FQDN in the tables is to allow customers to manage traffic using PAC files or other proxy configurations, see our guide to [managing Office 365 endpoints](./managing-office-365-endpoints.md) for example PAC files.</span></span>
  
<span data-ttu-id="86338-169">在某些情况下，我们使用了通配符域，其中一个或多个子 FQDN 的播发方式与更高级别的通配符域不同。</span><span class="sxs-lookup"><span data-stu-id="86338-169">In some situations we've used a wildcard domain where one or more sub-FQDNs are advertised differently than the higher-level wildcard domain.</span></span> <span data-ttu-id="86338-170">当通配符表示所有播发到 ExpressRoute 和 Internet 的服务器长列表，而仅向 Internet 播发一小部分目标或反向播发目标时，通常会发生这种情况。</span><span class="sxs-lookup"><span data-stu-id="86338-170">This usually happens when the wildcard represents a long list of servers that are all advertised to ExpressRoute and the Internet, while a small subset of destinations is only advertised to the Internet, or the reverse.</span></span> <span data-ttu-id="86338-171">请参阅下面的表以了解区别。</span><span class="sxs-lookup"><span data-stu-id="86338-171">Refer to the tables below to understand where the differences are.</span></span>
  
<span data-ttu-id="86338-172">此表显示向 Internet 和 Azure ExpressRoute 播发的通配符 FQDN 以及仅向 Internet 播发的子 FQDN。</span><span class="sxs-lookup"><span data-stu-id="86338-172">This table displays the wildcard FQDNs that are advertised to both the internet and Azure ExpressRoute alongside the sub-FQDNs that are advertised only to the internet.</span></span>

|<span data-ttu-id="86338-173">**向 ExpressRoute 和 Internet 线路播发的通配符域**</span><span class="sxs-lookup"><span data-stu-id="86338-173">**Wildcard domain advertised to ExpressRoute and Internet circuits**</span></span>|<span data-ttu-id="86338-174">**仅向 Internet 线路播发的子 FQDN**</span><span class="sxs-lookup"><span data-stu-id="86338-174">**Sub-FQDN advertised to Internet circuits only**</span></span>|
|:-----|:-----|
|<span data-ttu-id="86338-175">\*.microsoftonline.com</span><span class="sxs-lookup"><span data-stu-id="86338-175">\*.microsoftonline.com</span></span>  <br/> |<span data-ttu-id="86338-176">click.email.microsoftonline.com</span><span class="sxs-lookup"><span data-stu-id="86338-176">click.email.microsoftonline.com</span></span>  <br/> <span data-ttu-id="86338-177">portal.microsoftonline.com</span><span class="sxs-lookup"><span data-stu-id="86338-177">portal.microsoftonline.com</span></span>  <br/> <span data-ttu-id="86338-178">provisioningapi.microsoftonline.com</span><span class="sxs-lookup"><span data-stu-id="86338-178">provisioningapi.microsoftonline.com</span></span>  <br/> <span data-ttu-id="86338-179">adminwebservice.microsoftonline.com</span><span class="sxs-lookup"><span data-stu-id="86338-179">adminwebservice.microsoftonline.com</span></span>  <br/> |
|<span data-ttu-id="86338-180">\*.officeapps.live.com</span><span class="sxs-lookup"><span data-stu-id="86338-180">\*.officeapps.live.com</span></span>  <br/> |<span data-ttu-id="86338-181">nexusRules.officeapps.live.com</span><span class="sxs-lookup"><span data-stu-id="86338-181">nexusRules.officeapps.live.com</span></span>  <br/> <span data-ttu-id="86338-182">nexus.officeapps.live.com</span><span class="sxs-lookup"><span data-stu-id="86338-182">nexus.officeapps.live.com</span></span>  <br/> <span data-ttu-id="86338-183">odc.officeapps.live.com</span><span class="sxs-lookup"><span data-stu-id="86338-183">odc.officeapps.live.com</span></span>  <br/> <span data-ttu-id="86338-184">odc.officeapps.live.com</span><span class="sxs-lookup"><span data-stu-id="86338-184">odc.officeapps.live.com</span></span>  <br/> <span data-ttu-id="86338-185">cdn.odc.officeapps.live.com</span><span class="sxs-lookup"><span data-stu-id="86338-185">cdn.odc.officeapps.live.com</span></span>  <br/> <span data-ttu-id="86338-186">ols.officeapps.live.com</span><span class="sxs-lookup"><span data-stu-id="86338-186">ols.officeapps.live.com</span></span>  <br/> <span data-ttu-id="86338-187">ocsredir.officeapps.live.com</span><span class="sxs-lookup"><span data-stu-id="86338-187">ocsredir.officeapps.live.com</span></span>  <br/> <span data-ttu-id="86338-188">ocws.officeapps.live.com</span><span class="sxs-lookup"><span data-stu-id="86338-188">ocws.officeapps.live.com</span></span>  <br/> <span data-ttu-id="86338-189">ocsa.officeapps.live.com</span><span class="sxs-lookup"><span data-stu-id="86338-189">ocsa.officeapps.live.com</span></span>  <br/> |

<span data-ttu-id="86338-190">通常，PAC 文件旨在将网络请求直接发送到 ExpressRoute 播发的终结点，并将所有其他网络请求发送到代理。</span><span class="sxs-lookup"><span data-stu-id="86338-190">Usually PAC files are intended to send network requests to ExpressRoute advertised endpoints directly to the circuit and all other network requests to your proxy.</span></span> <span data-ttu-id="86338-191">如果你要配置类似这样的 PAC 文件，请按以下顺序撰写 PAC 文件：</span><span class="sxs-lookup"><span data-stu-id="86338-191">If you're configuring a PAC file like this, compose your PAC file in the following order:</span></span>
  
1. <span data-ttu-id="86338-192">在 PAC 文件顶部包含上表中第二列的子 FQN，向代理发送流量。</span><span class="sxs-lookup"><span data-stu-id="86338-192">Include the sub-FQDNs from column two in the above table at the top of your PAC file, sending the traffic towards your proxy.</span></span> <span data-ttu-id="86338-193">我们已生成示例 PAC 文件，供你在管理 [Office 365](./managing-office-365-endpoints.md)终结点一文使用。</span><span class="sxs-lookup"><span data-stu-id="86338-193">We've built a sample PAC file for you to use in our article on [managing Office 365 endpoints](./managing-office-365-endpoints.md).</span></span>

2. <span data-ttu-id="86338-194">包括本文第一节下方标记为 ExpressRoute 的所有[](./urls-and-ip-address-ranges.md)FQDN，将流量直接发送到 ExpressRoute 电路。</span><span class="sxs-lookup"><span data-stu-id="86338-194">Include all FQDNs marked advertised to ExpressRoute in [this article](./urls-and-ip-address-ranges.md) below the first section, sending the traffic directly to your ExpressRoute circuit.</span></span>

3. <span data-ttu-id="86338-195">包括这两个条目下方的任何其他网络终结点或规则，向代理发送流量。</span><span class="sxs-lookup"><span data-stu-id="86338-195">Include any other network endpoints or rules below these two entries, sending the traffic towards your proxy.</span></span>

<span data-ttu-id="86338-196">此表只显示在向 Azure ExpressRoute 和 Internet 线路播发的子 FQN 旁边公布到 Internet 线路的通配符域。</span><span class="sxs-lookup"><span data-stu-id="86338-196">This table displays the wildcard domains that are advertised to Internet circuits only alongside the sub-FQDNs that are advertised to Azure ExpressRoute and Internet circuits.</span></span> <span data-ttu-id="86338-197">对于上面的 PAC 文件，下表第 2 列的 FQDN 将在引用的链接中列为向 ExpressRoute 播发，这意味着它们将包含在文件的第二组条目中。</span><span class="sxs-lookup"><span data-stu-id="86338-197">For your PAC file above, the FQDNs in column 2 in the below table are listed as being advertised to ExpressRoute in the link referenced, which means they would be included in the second group of entries in the file.</span></span>

|<span data-ttu-id="86338-198">**仅向 Internet 线路播发的通配符域**</span><span class="sxs-lookup"><span data-stu-id="86338-198">**Wildcard domain advertised to Internet circuits only**</span></span>|<span data-ttu-id="86338-199">**向 ExpressRoute 和 Internet 线路播发的子 FQDN**</span><span class="sxs-lookup"><span data-stu-id="86338-199">**Sub-FQDN advertised to ExpressRoute and Internet circuits**</span></span>|
|:-----|:-----|
|<span data-ttu-id="86338-200">\*.office.com</span><span class="sxs-lookup"><span data-stu-id="86338-200">\*.office.com</span></span>  <br/> |<span data-ttu-id="86338-201">\*.outlook.office.com</span><span class="sxs-lookup"><span data-stu-id="86338-201">\*.outlook.office.com</span></span>  <br/> <span data-ttu-id="86338-202">home.office.com</span><span class="sxs-lookup"><span data-stu-id="86338-202">home.office.com</span></span>  <br/> <span data-ttu-id="86338-203">outlook.office.com</span><span class="sxs-lookup"><span data-stu-id="86338-203">outlook.office.com</span></span>  <br/> <span data-ttu-id="86338-204">portal.office.com</span><span class="sxs-lookup"><span data-stu-id="86338-204">portal.office.com</span></span>  <br/> <div style="display: inline"><span data-ttu-id="86338-205">www.office.com</span><span class="sxs-lookup"><span data-stu-id="86338-205">www.office.com</span></span></div>  <br/> |
|<span data-ttu-id="86338-206">\*.office.net</span><span class="sxs-lookup"><span data-stu-id="86338-206">\*.office.net</span></span>  <br/> |<span data-ttu-id="86338-207">agent.office.net</span><span class="sxs-lookup"><span data-stu-id="86338-207">agent.office.net</span></span>  <br/> |
|<span data-ttu-id="86338-208">\*.office365.com</span><span class="sxs-lookup"><span data-stu-id="86338-208">\*.office365.com</span></span>  <br/> |<span data-ttu-id="86338-209">outlook.office365.com</span><span class="sxs-lookup"><span data-stu-id="86338-209">outlook.office365.com</span></span>  <br/> <span data-ttu-id="86338-210">smtp.office365.com</span><span class="sxs-lookup"><span data-stu-id="86338-210">smtp.office365.com</span></span>  <br/> |
|<span data-ttu-id="86338-211">\*.outlook.com</span><span class="sxs-lookup"><span data-stu-id="86338-211">\*.outlook.com</span></span>  <br/> |<span data-ttu-id="86338-212">\*.protection.outlook.com</span><span class="sxs-lookup"><span data-stu-id="86338-212">\*.protection.outlook.com</span></span>  <br/> <span data-ttu-id="86338-213">\*.mail.protection.outlook.com</span><span class="sxs-lookup"><span data-stu-id="86338-213">\*.mail.protection.outlook.com</span></span>  <br/> <span data-ttu-id="86338-214">autodiscover- \<tenant\> .outlook.com</span><span class="sxs-lookup"><span data-stu-id="86338-214">autodiscover-\<tenant\>.outlook.com</span></span>  <br/> |
|<span data-ttu-id="86338-215">\*.windows.net</span><span class="sxs-lookup"><span data-stu-id="86338-215">\*.windows.net</span></span>  <br/> |<span data-ttu-id="86338-216">login.windows.net</span><span class="sxs-lookup"><span data-stu-id="86338-216">login.windows.net</span></span>  <br/> |

## <a name="routing-office-365-traffic-over-the-internet-and-expressroute"></a><span data-ttu-id="86338-217">通过 Internet 和 ExpressRoute 路由 Office 365 流量</span><span class="sxs-lookup"><span data-stu-id="86338-217">Routing Office 365 traffic over the Internet and ExpressRoute</span></span>

<span data-ttu-id="86338-218">若要路由到你选择的 Office 365 应用程序，你需要确定许多关键因素。</span><span class="sxs-lookup"><span data-stu-id="86338-218">To route to the Office 365 application of your choosing, you'll need to determine a number of key factors.</span></span>
  
1. <span data-ttu-id="86338-219">应用程序将需要多少带宽。</span><span class="sxs-lookup"><span data-stu-id="86338-219">How much bandwidth the application will require.</span></span> <span data-ttu-id="86338-220">对现有使用情况采样是确定组织中这一点的唯一可靠方法。</span><span class="sxs-lookup"><span data-stu-id="86338-220">Sampling existing usage is the only reliable method for determining this in your organization.</span></span>

2. <span data-ttu-id="86338-221">您希望网络流量 () 的出口位置。</span><span class="sxs-lookup"><span data-stu-id="86338-221">What egress location(s) you want the network traffic to leave your network from.</span></span> <span data-ttu-id="86338-222">应计划最大程度地降低与 Office 365 的连接的网络延迟，因为这样做会影响性能。</span><span class="sxs-lookup"><span data-stu-id="86338-222">You should plan to minimize the network latency for connectivity to Office 365 as this will impact performance.</span></span> <span data-ttu-id="86338-223">由于 Skype for Business 使用实时语音和视频，因此它特别容易受到较差的网络延迟的影响。</span><span class="sxs-lookup"><span data-stu-id="86338-223">Because Skype for Business uses real-time voice and video, it is particularly susceptible to poor network latency.</span></span>

3. <span data-ttu-id="86338-224">如果你希望所有或部分网络位置使用 ExpressRoute。</span><span class="sxs-lookup"><span data-stu-id="86338-224">If you want all or a subset of your network locations to use ExpressRoute.</span></span>

4. <span data-ttu-id="86338-225">所选网络提供商从什么位置提供 ExpressRoute。</span><span class="sxs-lookup"><span data-stu-id="86338-225">What locations your chosen network provider offers ExpressRoute from.</span></span>

<span data-ttu-id="86338-226">确定这些问题的解答后，可以设置满足带宽和位置需求的 ExpressRoute 电路。</span><span class="sxs-lookup"><span data-stu-id="86338-226">Once you determine the answers to these questions, you can provision an ExpressRoute circuit that meets the bandwidth and location needs.</span></span> <span data-ttu-id="86338-227">有关更多网络规划协助，请参阅 [Office 365](./network-planning-and-performance.md) 网络调整指南和 Microsoft 如何处理网络性能 [规划的案例研究](https://aka.ms/tunemsit)。</span><span class="sxs-lookup"><span data-stu-id="86338-227">For more network planning assistance, refer to the [Office 365 network tuning guide](./network-planning-and-performance.md) and the [case study on how Microsoft handles network performance planning](https://aka.ms/tunemsit).</span></span>
  
### <a name="example-1-single-geographic-location"></a><span data-ttu-id="86338-228">示例 1：单个地理位置</span><span class="sxs-lookup"><span data-stu-id="86338-228">Example 1: Single geographic location</span></span>
  
<span data-ttu-id="86338-229">此示例是名为 Trey Research 的虚构公司的方案，该公司具有一个地理位置。</span><span class="sxs-lookup"><span data-stu-id="86338-229">This example is a scenario for a fictitious company called Trey Research who has a single geographic location.</span></span>
  
<span data-ttu-id="86338-230">Trey Research 的员工只能连接到安全部门明确允许的 Internet 上的服务和网站，这些代理对位于企业网络与 ISP 之间的出站代理对上。</span><span class="sxs-lookup"><span data-stu-id="86338-230">Employees at Trey Research are only allowed to connect to the services and websites on the internet that the security department explicitly allows on the pair of outbound proxies that sit between the corporate network and their ISP.</span></span>
  
<span data-ttu-id="86338-231">Trey Research 计划将 Azure ExpressRoute 用于 Office 365，并意识到某些流量（如发往内容交付网络的流量）将无法通过 ExpressRoute for Office 365 连接进行路由。</span><span class="sxs-lookup"><span data-stu-id="86338-231">Trey Research plans to use Azure ExpressRoute for Office 365 and recognizes that some traffic such as traffic destined for content delivery networks won't be able to route over the ExpressRoute for Office 365 connection.</span></span> <span data-ttu-id="86338-232">由于默认情况下，所有流量已路由到代理设备，因此这些请求将继续像以前一样工作。</span><span class="sxs-lookup"><span data-stu-id="86338-232">Since all traffic already routes to the proxy devices by default, these requests will continue to work as before.</span></span> <span data-ttu-id="86338-233">Trey Research 确定他们可以满足 Azure ExpressRoute 路由要求后，他们继续创建电路、配置路由以及将新的 ExpressRoute 电路链接到虚拟网络。</span><span class="sxs-lookup"><span data-stu-id="86338-233">After Trey Research determines they can meet the Azure ExpressRoute routing requirements, they proceed to create a circuit, configure routing, and linking the new ExpressRoute circuit to a virtual network.</span></span> <span data-ttu-id="86338-234">基本 Azure ExpressRoute 配置就位后，Trey Research 将使用我们发布的 [#2 PAC](./managing-office-365-endpoints.md)  文件，通过直接 ExpressRoute for Office 365 连接路由包含客户特定数据的流量。</span><span class="sxs-lookup"><span data-stu-id="86338-234">Once the fundamental Azure ExpressRoute configuration is in place, Trey Research uses the [#2 PAC file we publish](./managing-office-365-endpoints.md)  to route traffic with customer-specific data over the direct ExpressRoute for Office 365 connections.</span></span>
  
<span data-ttu-id="86338-235">如下图所示，Trey Research 能够满足通过 Internet 路由 Office 365 流量和通过 ExpressRoute 的流量子集（结合使用路由和出站代理配置更改）的要求。</span><span class="sxs-lookup"><span data-stu-id="86338-235">As shown in the following diagram, Trey Research is able to satisfy the requirement to route Office 365 traffic over the internet and a subset of traffic over ExpressRoute using a combination of routing and outbound proxy configuration changes.</span></span>
  
1. <span data-ttu-id="86338-236">使用#2 [PAC](./managing-office-365-endpoints.md) 文件，通过适用于 Office 365 的 Azure ExpressRoute 的单独 Internet 出口点路由流量。</span><span class="sxs-lookup"><span data-stu-id="86338-236">Using the [#2 PAC file we publish](./managing-office-365-endpoints.md) to route traffic through a separate internet egress point for Azure ExpressRoute for Office 365.</span></span>

2. <span data-ttu-id="86338-237">客户端配置了针对 Trey Research 代理的默认路由。</span><span class="sxs-lookup"><span data-stu-id="86338-237">Clients are configured with a default route towards Trey Research's proxies.</span></span>

<span data-ttu-id="86338-238">在此示例方案中，Trey Research 使用出站代理设备。</span><span class="sxs-lookup"><span data-stu-id="86338-238">In this example scenario, Trey Research is using an outbound proxy device.</span></span> <span data-ttu-id="86338-239">同样，不使用适用于 Office 365 的 Azure ExpressRoute 的客户可能希望使用此技术根据检查发往已知高批量终结点的流量的成本来路由流量。</span><span class="sxs-lookup"><span data-stu-id="86338-239">Similarly, customers who aren't using Azure ExpressRoute for Office 365 may want to use this technique to route traffic based on the cost of inspecting traffic destined for well-known high volume endpoints.</span></span>
  
<span data-ttu-id="86338-240">Exchange Online、SharePoint Online 和 Skype for Business Online 的 FQDN 最大数量如下：</span><span class="sxs-lookup"><span data-stu-id="86338-240">The highest volume FQDNs for Exchange Online, SharePoint Online, and Skype for Business Online are the following:</span></span>
  
![ExpressRoute 客户边缘网络](../media/dab8cc42-b1d6-46d6-b2f6-d70f9e16d5ea.png)
  
- <span data-ttu-id="86338-242">outlook.office365.com、outlook.office.com</span><span class="sxs-lookup"><span data-stu-id="86338-242">outlook.office365.com, outlook.office.com</span></span>

- <span data-ttu-id="86338-243">\<tenant-name\>\<tenant-name\>.sharepoint.com、-my.sharepoint.com、.sharepoint.com \<tenant-name\> - \<app\></span><span class="sxs-lookup"><span data-stu-id="86338-243">\<tenant-name\>.sharepoint.com, \<tenant-name\>-my.sharepoint.com, \<tenant-name\>-\<app\>.sharepoint.com</span></span>

- <span data-ttu-id="86338-244">\*.Lync.com TCP 流量的 IP 范围</span><span class="sxs-lookup"><span data-stu-id="86338-244">\*.Lync.com along with the IP ranges for non-TCP traffic</span></span>

- <span data-ttu-id="86338-245">\*\* \* \* \* broadcast.officeapps.live.com、excel.officeapps.live.com、onenote.officeapps.live.com、powerpoint.officeapps.live.com、view.officeapps.live.com、visio.officeapps.live.com、word-edit.officeapps.live.com、word-view.officeapps.live.com、office.live.com \* \* \*</span><span class="sxs-lookup"><span data-stu-id="86338-245">\*broadcast.officeapps.live.com, \*excel.officeapps.live.com, \*onenote.officeapps.live.com, \*powerpoint.officeapps.live.com, \*view.officeapps.live.com, \*visio.officeapps.live.com, \*word-edit.officeapps.live.com, \*word-view.officeapps.live.com, office.live.com</span></span>

<span data-ttu-id="86338-246">了解有关在 [Windows 8](/archive/blogs/deploymentguys/windows-8-supporting-proxy-services-with-static-configurations-web-hosted-pac-files-and-domain-policy-configured-proxy) 中部署和管理代理设置以及 [确保 Office 365 不会受代理限制的更多信息](https://blogs.technet.com/b/onthewire/archive/2014/03/28/ensuring-your-office-365-network-connection-isn-t-throttled-by-your-proxy.aspx)。</span><span class="sxs-lookup"><span data-stu-id="86338-246">Learn more about [deploying and managing proxy settings in Windows 8](/archive/blogs/deploymentguys/windows-8-supporting-proxy-services-with-static-configurations-web-hosted-pac-files-and-domain-policy-configured-proxy) and [ensuring Office 365 isn't throttled by your proxy](https://blogs.technet.com/b/onthewire/archive/2014/03/28/ensuring-your-office-365-network-connection-isn-t-throttled-by-your-proxy.aspx).</span></span>
  
<span data-ttu-id="86338-247">对于单个 ExpressRoute 电路，Trey Research 没有高可用性。</span><span class="sxs-lookup"><span data-stu-id="86338-247">With a single ExpressRoute circuit, there is no high availability for Trey Research.</span></span> <span data-ttu-id="86338-248">如果为 ExpressRoute 连接提供服务的边缘设备的 Trey 的冗余对出现故障，则没有要故障转移到的其他 ExpressRoute 电路。</span><span class="sxs-lookup"><span data-stu-id="86338-248">In the event Trey's redundant pair of edge devices that are servicing the ExpressRoute connectivity fail, there is not an additional ExpressRoute circuit to failover to.</span></span> <span data-ttu-id="86338-249">这使得 Trey Research 在预先开发中无法通过 Internet 进行重新配置，在某些情况下需要新的 IP 地址。</span><span class="sxs-lookup"><span data-stu-id="86338-249">This leaves Trey Research in a predicament as failing over to the internet will require manual reconfiguration and in some cases new IP addresses.</span></span> <span data-ttu-id="86338-250">如果 Trey 要添加高可用性，最简单的解决方案是为每个位置添加额外的 ExpressRoute 电路，并主动/主动地配置这些电路。</span><span class="sxs-lookup"><span data-stu-id="86338-250">If Trey wants to add high availability, the simplest solution is to add additional ExpressRoute circuits for each location and configure the circuits in an active/active manner.</span></span>
  
## <a name="routing-expressroute-for-office-365-with-multiple-locations"></a><span data-ttu-id="86338-251">通过多个位置路由适用于 Office 365 的 ExpressRoute</span><span class="sxs-lookup"><span data-stu-id="86338-251">Routing ExpressRoute for Office 365 with multiple locations</span></span>

<span data-ttu-id="86338-252">最后一个方案是，通过 ExpressRoute 路由 Office 365 流量是更复杂的路由体系结构的基础。</span><span class="sxs-lookup"><span data-stu-id="86338-252">The last scenario, routing Office 365 traffic over ExpressRoute is the foundation for even more complex routing architecture.</span></span> <span data-ttu-id="86338-253">无论位置数量、存在这些位置的洲数、ExpressRoute 电路数等，都需要能够将一些流量路由到 Internet，而需要通过 ExpressRoute 路由一些流量。</span><span class="sxs-lookup"><span data-stu-id="86338-253">Regardless of the number of locations, number of continents where those locations exist, number of ExpressRoute circuits, and so on, being able to route some traffic to the Internet and some traffic over ExpressRoute will be required.</span></span>
  
<span data-ttu-id="86338-254">对于位于多个地理位置的客户，必须回答的其他问题包括：</span><span class="sxs-lookup"><span data-stu-id="86338-254">The additional questions that must be answered for customers with multiple locations in multiple geographies include:</span></span>
  
1. <span data-ttu-id="86338-255">是否需要每个位置的 ExpressRoute 电路？</span><span class="sxs-lookup"><span data-stu-id="86338-255">Do you require an ExpressRoute circuit in every location?</span></span> <span data-ttu-id="86338-256">如果你使用的是 Skype for Business Online 或关注 SharePoint Online 或 Exchange Online 的延迟敏感度，建议在每个位置使用主动/主动 ExpressRoute 电路的冗余对。</span><span class="sxs-lookup"><span data-stu-id="86338-256">If you're using Skype for Business Online or are concerned with latency sensitivity for SharePoint Online or Exchange Online, a redundant pair of active/active ExpressRoute circuits is recommended in each location.</span></span> <span data-ttu-id="86338-257">有关详细信息，请参阅 Skype for Business 媒体质量和网络连接指南。</span><span class="sxs-lookup"><span data-stu-id="86338-257">See the Skype for Business media quality and network connectivity guide for more details.</span></span>

2. <span data-ttu-id="86338-258">如果 ExpressRoute 电路不可用于特定区域，那么如何路由发往 Office 365 的流量？</span><span class="sxs-lookup"><span data-stu-id="86338-258">If an ExpressRoute circuit isn't available in a particular region, how should Office 365 destined traffic be routed?</span></span>

3. <span data-ttu-id="86338-259">在具有很多较小位置的网络的情况下，合并流量的首选方法是什么？</span><span class="sxs-lookup"><span data-stu-id="86338-259">What is the preferred method for consolidating traffic in the case of networks with many small locations?</span></span>

<span data-ttu-id="86338-260">每一项都提出了一个独特挑战，要求你评估自己的网络和 Microsoft 提供的选项。</span><span class="sxs-lookup"><span data-stu-id="86338-260">Each of these presents a unique challenge that requires you to evaluate your own network and the options available from Microsoft.</span></span>

|<span data-ttu-id="86338-261">**注意事项**</span><span class="sxs-lookup"><span data-stu-id="86338-261">**Consideration**</span></span>|<span data-ttu-id="86338-262">**要评估的网络组件**</span><span class="sxs-lookup"><span data-stu-id="86338-262">**Network components to evaluate**</span></span>|
|:-----|:-----|
|<span data-ttu-id="86338-263">位于多个位置的电路</span><span class="sxs-lookup"><span data-stu-id="86338-263">Circuits in more than one location</span></span>  <br/> |<span data-ttu-id="86338-264">建议至少以主动/主动方式配置两条电路。</span><span class="sxs-lookup"><span data-stu-id="86338-264">We recommend a minimum of two circuits configured in an active/active manner.</span></span>  <br/> <span data-ttu-id="86338-265">必须比较成本、延迟和带宽需求。</span><span class="sxs-lookup"><span data-stu-id="86338-265">Cost, latency, and bandwidth needs must be compared.</span></span>  <br/> <span data-ttu-id="86338-266">使用 BGP 路由开销、PAC 文件和 NAT 管理具有多个电路的路由。</span><span class="sxs-lookup"><span data-stu-id="86338-266">Use BGP route cost, PAC files, and NAT to manage routing with multiple circuits.</span></span>  <br/> |
|<span data-ttu-id="86338-267">从没有 ExpressRoute 电路的位置路由</span><span class="sxs-lookup"><span data-stu-id="86338-267">Routing from locations without an ExpressRoute circuit</span></span>  <br/> |<span data-ttu-id="86338-268">我们建议出口和 DNS 解析与发起 Office 365 请求的人接近。</span><span class="sxs-lookup"><span data-stu-id="86338-268">We recommend egress and DNS resolution as close to the person initiating the request for Office 365.</span></span>  <br/> <span data-ttu-id="86338-269">DNS 转发可用于允许远程办公室发现相应的终结点。</span><span class="sxs-lookup"><span data-stu-id="86338-269">DNS forwarding can be used to allow remote offices to discover the appropriate endpoint.</span></span>  <br/> <span data-ttu-id="86338-270">远程办公室中的客户端必须具有提供对 ExpressRoute 电路的访问的路由。</span><span class="sxs-lookup"><span data-stu-id="86338-270">Clients in the remote office must have a route available that provides access to the ExpressRoute circuit.</span></span>  <br/> |
|<span data-ttu-id="86338-271">小型办公室合并</span><span class="sxs-lookup"><span data-stu-id="86338-271">Small office consolidation</span></span>  <br/> |<span data-ttu-id="86338-272">应仔细比较可用带宽和数据使用情况。</span><span class="sxs-lookup"><span data-stu-id="86338-272">Available bandwidth and data usage should be carefully compared.</span></span>  <br/> |

> [!NOTE]
> <span data-ttu-id="86338-273">如果无论物理位置如何，路由都可用，Microsoft 将首选 ExpressRoute over the Internet。</span><span class="sxs-lookup"><span data-stu-id="86338-273">Microsoft will prefer ExpressRoute over the internet if the route is available regardless of physical location.</span></span>
  
<span data-ttu-id="86338-274">每个唯一网络必须考虑上述每个注意事项。</span><span class="sxs-lookup"><span data-stu-id="86338-274">Each of these considerations must be taken into account for each unique network.</span></span> <span data-ttu-id="86338-275">下面是一个示例。</span><span class="sxs-lookup"><span data-stu-id="86338-275">Below is an example.</span></span>
  
### <a name="example-2-multi-geographic-locations"></a><span data-ttu-id="86338-276">示例 2：多地理位置</span><span class="sxs-lookup"><span data-stu-id="86338-276">Example 2: Multi-geographic locations</span></span>
  
<span data-ttu-id="86338-277">此示例是一个虚构公司 Humongous Insurance 的方案，该公司具有多个地理位置。</span><span class="sxs-lookup"><span data-stu-id="86338-277">This example is a scenario for a fictitious company called Humongous Insurance who has multiple geographic locations.</span></span>
  
<span data-ttu-id="86338-278">Humongous Insurance 地理位置分散，办事处分布于全球。</span><span class="sxs-lookup"><span data-stu-id="86338-278">Humongous Insurance is geographically dispersed with offices all over the world.</span></span> <span data-ttu-id="86338-279">他们希望实现适用于 Office 365 的 Azure ExpressRoute，以在直接网络连接上保留大部分 Office 365 流量。</span><span class="sxs-lookup"><span data-stu-id="86338-279">They want to implement Azure ExpressRoute for Office 365 to keep most their Office 365 traffic on direct network connections.</span></span> <span data-ttu-id="86338-280">Humongous Insurance 还在另外两个洲设有办事处。</span><span class="sxs-lookup"><span data-stu-id="86338-280">Humongous Insurance also has offices on two additional continents.</span></span> <span data-ttu-id="86338-281">远程办公室（其中 ExpressRoute 不可行）的员工将需要路由回一个或两个主要设施，以使用 ExpressRoute 连接。</span><span class="sxs-lookup"><span data-stu-id="86338-281">The employees in the remote office where ExpressRoute is not feasible will need to route back to one or both of the primary facilities to use an ExpressRoute connection.</span></span>
  
<span data-ttu-id="86338-282">指导原则是尽快将 Office 365 发往 Microsoft 数据中心的流量。</span><span class="sxs-lookup"><span data-stu-id="86338-282">The guiding principle is to get Office 365 destined traffic to a Microsoft datacenter as quickly as possible.</span></span> <span data-ttu-id="86338-283">在此例中，Humongous Insurance 必须决定其远程办公室是应尽快通过 Internet 路由到 Microsoft 数据中心，还是其远程办公室应尽快通过内部网络路由，以通过 ExpressRoute 连接到达 Microsoft 数据中心。</span><span class="sxs-lookup"><span data-stu-id="86338-283">In this example, Humongous Insurance must decide if their remote offices should route over the Internet to get to a Microsoft datacenter over any connection as quickly as possible or if their remote offices should route over an internal network to get to a Microsoft datacenter over an ExpressRoute connection as quickly as possible.</span></span>
  
<span data-ttu-id="86338-284">Microsoft 的数据中心、网络和应用程序体系结构旨在采用全球不同的通信，并尽可能以最有效的方式提供服务。</span><span class="sxs-lookup"><span data-stu-id="86338-284">Microsoft's datacenters, networks, and application architecture are designed to take globally disparate communications and service them in the most efficient way possible.</span></span> <span data-ttu-id="86338-285">这是世界上最大的网络之一。</span><span class="sxs-lookup"><span data-stu-id="86338-285">This is one of the largest networks in the world.</span></span> <span data-ttu-id="86338-286">发往 Office 365 的请求在客户网络上保留的时间超过所需时间将无法利用此体系结构。</span><span class="sxs-lookup"><span data-stu-id="86338-286">Requests destined for Office 365 that remain on customer networks longer than necessary won't be able to take advantage of this architecture.</span></span>
  
<span data-ttu-id="86338-287">在 Humongous Insurance 的情况中，他们应按照打算通过 ExpressRoute 使用的应用程序继续操作。</span><span class="sxs-lookup"><span data-stu-id="86338-287">In Humongous Insurance's situation, they should proceed depending on the applications they intend to use over ExpressRoute.</span></span> <span data-ttu-id="86338-288">例如，如果他们是 Skype for Business Online 客户，或者计划在连接到外部 Skype for Business Online 会议时使用 ExpressRoute 连接，Skype for Business Online 媒体质量和网络连接指南中推荐的设计就是为第三个位置设置额外的 ExpressRoute 电路。</span><span class="sxs-lookup"><span data-stu-id="86338-288">For example, if they're a Skype for Business Online customer, or plan to use ExpressRoute connectivity when connecting to external Skype for Business Online meetings, the design recommended in the Skype for Business Online media quality and network connectivity guide is to provision an additional ExpressRoute circuit for the third location.</span></span> <span data-ttu-id="86338-289">从网络的角度来看，这可能更昂贵;但是，在传送至 Microsoft 数据中心之前，将请求从一个洲路由到另一个洲可能会导致 Skype for Business Online 会议和通信期间体验不佳或不可用。</span><span class="sxs-lookup"><span data-stu-id="86338-289">This may be more expensive from a networking perspective; however, routing requests from one continent to another before delivering to a Microsoft datacenter may cause a poor or unusable experience during Skype for Business Online meetings and communications.</span></span>
  
<span data-ttu-id="86338-290">如果 Humongous Insurance 未使用或计划以任何方式使用 Skype for Business Online，将发往 Office 365 的网络流量路由回使用 ExpressRoute 连接的洲可能可行，但可能会导致不必要的延迟或 TCP 拥塞。</span><span class="sxs-lookup"><span data-stu-id="86338-290">If Humongous Insurance isn't using or doesn't plan to use Skype for Business Online in any way, routing Office 365 destined network traffic back to a continent with an ExpressRoute connection may be feasible though may cause unnecessary latency or TCP congestion.</span></span> <span data-ttu-id="86338-291">在这两种情况下，建议将 Internet 目标流量路由到本地站点的 Internet，以利用 Office 365 所依赖的内容交付网络。</span><span class="sxs-lookup"><span data-stu-id="86338-291">In both cases, routing Internet destined traffic to the Internet at the local site is recommended to take advantage of the content delivery networks that Office 365 relies on.</span></span>
  
![ExpressRoute 多地理位置](../media/98fdd883-2c5a-4df7-844b-bd28cd0b9f50.png)
  
<span data-ttu-id="86338-293">当 Humongous Insurance 规划其多地理位置策略时，需要考虑大量有关电路大小、电路数量、故障转移等内容。</span><span class="sxs-lookup"><span data-stu-id="86338-293">When Humongous Insurance is planning their multi-geography strategy, there are a number of things to consider around size of circuit, number of circuits, failover, and so on.</span></span>
  
<span data-ttu-id="86338-294">由于 ExpressRoute 位于一个位置，且多个区域试图使用该电路，Humongous Insurance 希望确保从远程办公室连接到 Office 365 时发送到最近的总部的 Office 365 数据中心，并且由总部位置接收。</span><span class="sxs-lookup"><span data-stu-id="86338-294">With ExpressRoute in a single location with multiple regions attempting to use the circuit, Humongous Insurance wants to ensure that connections to Office 365 from the remote office are sent to the Office 365 datacenter nearest headquarters and received by the headquarters location.</span></span> <span data-ttu-id="86338-295">为此，Humongous Insurance 实施了 DNS 转发，以减少与最接近总部 Internet 出口点的 Office 365 环境建立适当连接所需的往返次数和 DNS 查找次数。</span><span class="sxs-lookup"><span data-stu-id="86338-295">To do this, Humongous Insurance implements DNS forwarding to reduce the number of round trips and DNS lookups required to establish the appropriate connection with the Office 365 environment closest to the headquarters internet egress point.</span></span> <span data-ttu-id="86338-296">这可以防止客户端解析本地前端服务器，并确保Front-End连接到的 Front-End 服务器靠近 Humongous Insurance 与 Microsoft 对等的总部。</span><span class="sxs-lookup"><span data-stu-id="86338-296">This prevents the client from resolving a local front-end server and ensures the Front-End server the person connects to be near the headquarters where Humongous Insurance is peering with Microsoft.</span></span> <span data-ttu-id="86338-297">还可以了解如何为 [域名分配条件转发器](/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc794735(v=ws.10))。</span><span class="sxs-lookup"><span data-stu-id="86338-297">You can also learn to [Assign a Conditional Forwarder for a Domain Name](/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc794735(v=ws.10)).</span></span>
  
<span data-ttu-id="86338-298">在此方案中，来自远程办公室的流量将解析北美的 Office 365 前端基础结构，并使用 Office 365 根据 Office 365 应用程序的体系结构连接到后端服务器。</span><span class="sxs-lookup"><span data-stu-id="86338-298">In this scenario, traffic from the remote office would resolve the Office 365 front-end infrastructure in North America and use Office 365 to connect to the backend servers according to the architecture of the Office 365 application.</span></span> <span data-ttu-id="86338-299">例如，Exchange Online 将终止北美的连接，并且这些前端服务器将连接到租户驻留的后端邮箱服务器。</span><span class="sxs-lookup"><span data-stu-id="86338-299">For example, Exchange Online would terminate the connection in North America and those front-end servers would connect to the backend mailbox server wherever the tenant resided.</span></span> <span data-ttu-id="86338-300">所有服务都有广泛分布的由单播和单播目标组成的前端服务。</span><span class="sxs-lookup"><span data-stu-id="86338-300">All services have a widely distributed front door service comprised of unicast and anycast destinations.</span></span>
  
<span data-ttu-id="86338-301">如果 Humongous 在多个洲有主要办事处，建议每个区域至少存在两个活动/活动电路，以减少敏感应用程序（如 Skype for Business Online）的延迟。</span><span class="sxs-lookup"><span data-stu-id="86338-301">If Humongous has major offices in multiple continents, a minimum of two active/active circuits per region are recommended in order to reduce latency for sensitive applications such as Skype for Business Online.</span></span> <span data-ttu-id="86338-302">如果所有办事处都位于单个洲，或者没有使用实时协作，则具有合并或分布式出口点是客户特定的决定。</span><span class="sxs-lookup"><span data-stu-id="86338-302">If all offices are in a single continent, or is not using real-time collaboration, having a consolidated or distributed egress point is a customer-specific decision.</span></span> <span data-ttu-id="86338-303">当多个电路可用时，BGP 路由将确保在任何单个电路不可用时进行故障转移。</span><span class="sxs-lookup"><span data-stu-id="86338-303">When multiple circuits are available, BGP routing will ensure failover should any single circuit become unavailable.</span></span>
  
<span data-ttu-id="86338-304">详细了解示例 [路由配置和](/azure/expressroute/expressroute-config-samples-routing) [https://azure.microsoft.com/documentation/articles/expressroute-config-samples-nat/](/azure/expressroute/expressroute-config-samples-nat) 。</span><span class="sxs-lookup"><span data-stu-id="86338-304">Learn more about sample [routing configurations](/azure/expressroute/expressroute-config-samples-routing) and [https://azure.microsoft.com/documentation/articles/expressroute-config-samples-nat/](/azure/expressroute/expressroute-config-samples-nat).</span></span>
  
## <a name="selective-routing-with-expressroute"></a><span data-ttu-id="86338-305">使用 ExpressRoute 选择性路由</span><span class="sxs-lookup"><span data-stu-id="86338-305">Selective routing with ExpressRoute</span></span>

<span data-ttu-id="86338-306">出于各种原因（如测试，向部分用户推出 ExpressRoute）可能需要使用 ExpressRoute 进行选择性路由。</span><span class="sxs-lookup"><span data-stu-id="86338-306">Selective routing with ExpressRoute may be needed for a variety of reasons, such as testing, rolling out ExpressRoute to a subset of users.</span></span> <span data-ttu-id="86338-307">客户可以使用多种工具通过 ExpressRoute 选择性地路由 Office 365 网络流量：</span><span class="sxs-lookup"><span data-stu-id="86338-307">There are various tools customers can use to selectively route Office 365 network traffic over ExpressRoute:</span></span>
  
1. <span data-ttu-id="86338-308">**路由筛选/分离** - 允许 BGP 路由到 Office 365，通过 ExpressRoute 路由到子网或路由器的子集。</span><span class="sxs-lookup"><span data-stu-id="86338-308">**Route filtering/segregation** - allowing the BGP routes to Office 365 over ExpressRoute to a subset of your subnets or routers.</span></span> <span data-ttu-id="86338-309">这将按客户网络段或物理办公地点选择性地路由。</span><span class="sxs-lookup"><span data-stu-id="86338-309">This selectively routes by customer network segment or physical office location.</span></span> <span data-ttu-id="86338-310">这通常用于错开适用于 Office 365 的 ExpressRoute，并配置在 BGP 设备上。</span><span class="sxs-lookup"><span data-stu-id="86338-310">This is common for staggering rollout of ExpressRoute for Office 365 and is configured on your BGP devices.</span></span>

2. <span data-ttu-id="86338-311">**PAC 文件/URL** - 将发往 Office 365 的网络流量指示给特定 FQN 以路由到特定路径。</span><span class="sxs-lookup"><span data-stu-id="86338-311">**PAC files/URLs** - directing Office 365 destined network traffic for specific FQDNs to route on a specific path.</span></span> <span data-ttu-id="86338-312">这会选择性地按客户端计算机进行路由，由 [PAC](./managing-office-365-endpoints.md)文件部署 标识。</span><span class="sxs-lookup"><span data-stu-id="86338-312">This selectively routes by client computer as identified by [PAC file deployment](./managing-office-365-endpoints.md).</span></span>

3. <span data-ttu-id="86338-313">**路由筛选**  - [路由](/azure/expressroute/how-to-routefilter-portal)筛选器是一种通过 Microsoft 对等使用受支持服务的子集的方法。</span><span class="sxs-lookup"><span data-stu-id="86338-313">**Route filtering** - [Route filters](/azure/expressroute/how-to-routefilter-portal) are a way to consume a subset of supported services through Microsoft peering.</span></span>

4. <span data-ttu-id="86338-314">**BGP 社区** - 基于 [BGP](./bgp-communities-in-expressroute.md) 社区标记的筛选允许客户确定哪些 Office 365 应用程序将遍历 ExpressRoute，哪些应用程序将遍历 Internet。</span><span class="sxs-lookup"><span data-stu-id="86338-314">**BGP communities** - filtering based on [BGP community tags](./bgp-communities-in-expressroute.md) allows a customer to determine which Office 365 applications will traverse ExpressRoute and which will traverse the internet.</span></span>

<span data-ttu-id="86338-315">以下是可以用于返回的简短链接：[https://aka.ms/erorouting]()</span><span class="sxs-lookup"><span data-stu-id="86338-315">Here's a short link you can use to come back: [https://aka.ms/erorouting]()</span></span>
  
## <a name="related-topics"></a><span data-ttu-id="86338-316">相关主题</span><span class="sxs-lookup"><span data-stu-id="86338-316">Related Topics</span></span>

[<span data-ttu-id="86338-317">评估 Office 365 网络连接</span><span class="sxs-lookup"><span data-stu-id="86338-317">Assessing Office 365 network connectivity</span></span>](assessing-network-connectivity.md)
  
[<span data-ttu-id="86338-318">适用于 Office 365 的 Azure ExpressRoute</span><span class="sxs-lookup"><span data-stu-id="86338-318">Azure ExpressRoute for Office 365</span></span>](azure-expressroute.md)
  
[<span data-ttu-id="86338-319">管理 ExpressRoute for Office 365 连接</span><span class="sxs-lookup"><span data-stu-id="86338-319">Managing ExpressRoute for Office 365 connectivity</span></span>](managing-expressroute-for-connectivity.md)
  
[<span data-ttu-id="86338-320">ExpressRoute for Office 365 网络计划</span><span class="sxs-lookup"><span data-stu-id="86338-320">Network planning with ExpressRoute for Office 365</span></span>](network-planning-with-expressroute.md)
  
[<span data-ttu-id="86338-321">实现 ExpressRoute for Office 365</span><span class="sxs-lookup"><span data-stu-id="86338-321">Implementing ExpressRoute for Office 365</span></span>](implementing-expressroute.md)
  
[<span data-ttu-id="86338-322">Skype for Business Online 中的媒体质量和网络连接性能</span><span class="sxs-lookup"><span data-stu-id="86338-322">Media Quality and Network Connectivity Performance in Skype for Business Online</span></span>](https://support.office.com/article/5fe3e01b-34cf-44e0-b897-b0b2a83f0917)
  
[<span data-ttu-id="86338-323">优化 Skype for Business Online 网络</span><span class="sxs-lookup"><span data-stu-id="86338-323">Optimizing your network for Skype for Business Online</span></span>](https://support.office.com/article/b363bdca-b00d-4150-96c3-ec7eab5a8a43)
  
[<span data-ttu-id="86338-324">Skype for Business Online 中的 ExpressRoute 和 QoS</span><span class="sxs-lookup"><span data-stu-id="86338-324">ExpressRoute and QoS in Skype for Business Online</span></span>](https://support.office.com/article/20c654da-30ee-4e4f-a764-8b7d8844431d)
  
[<span data-ttu-id="86338-325">使用 ExpressRoute 的呼叫流</span><span class="sxs-lookup"><span data-stu-id="86338-325">Call flow using ExpressRoute</span></span>](https://support.office.com/article/413acb29-ad83-4393-9402-51d88e7561ab)
  
[<span data-ttu-id="86338-326">在 ExpressRoute for Office 365 方案中使用 BGP 社区</span><span class="sxs-lookup"><span data-stu-id="86338-326">Using BGP communities in ExpressRoute for Office 365 scenarios</span></span>](bgp-communities-in-expressroute.md)
  
[<span data-ttu-id="86338-327">使用基线和性能历史记录优化 Office 365 性能</span><span class="sxs-lookup"><span data-stu-id="86338-327">Office 365 performance tuning using baselines and performance history</span></span>](performance-tuning-using-baselines-and-history.md)
  
[<span data-ttu-id="86338-328">Office 365 性能疑难解答计划</span><span class="sxs-lookup"><span data-stu-id="86338-328">Performance troubleshooting plan for Office 365</span></span>](performance-troubleshooting-plan.md)
  
[<span data-ttu-id="86338-329">Office 365 URL 和 IP 地址范围</span><span class="sxs-lookup"><span data-stu-id="86338-329">Office 365 URLs and IP address ranges</span></span>](https://support.office.com/article/8548a211-3fe7-47cb-abb1-355ea5aa88a2)
  
[<span data-ttu-id="86338-330">Office 365 网络和性能优化</span><span class="sxs-lookup"><span data-stu-id="86338-330">Office 365 network and performance tuning</span></span>](network-planning-and-performance.md)
