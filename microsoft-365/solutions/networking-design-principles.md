---
title: 网络 (云) —一个架构师的见解
description: 了解如何通过避免最常见的错误来优化网络，实现云连接。
ms.author: bcarter
author: brendacarter
manager: bcarter
ms.audience: ITPro
ms.topic: article
ms.prod: microsoft-365-enterprise
localization_priority: Normal
ms.collection:
- M365-identity-device-management
- M365-security-compliance
ms.custom: ''
f1.keywords: NOCSH
ms.openlocfilehash: 7de9aec29b0a57e85e3539fc2e99384de545c52a
ms.sourcegitcommit: 27b2b2e5c41934b918cac2c171556c45e36661bf
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 03/19/2021
ms.locfileid: "50904632"
---
# <a name="networking-up-to-the-cloudone-architects-viewpoint"></a><span data-ttu-id="01b6a-103">网络 (云) —一个架构师的见解</span><span class="sxs-lookup"><span data-stu-id="01b6a-103">Networking up (to the cloud)—One architect’s viewpoint</span></span>

<span data-ttu-id="01b6a-104">本文中，Microsoft 安全与&架构师 [Ed Fisher](https://www.linkedin.com/in/edfisher/)介绍了如何避免最常见的错误来优化网络，实现云连接。</span><span class="sxs-lookup"><span data-stu-id="01b6a-104">In this article, [Ed Fisher](https://www.linkedin.com/in/edfisher/), Security & Compliance Architect at Microsoft, describes how to optimize your network for cloud connectivity by avoiding the most common pitfalls.</span></span> 

## <a name="about-the-author"></a><span data-ttu-id="01b6a-105">作者简介</span><span class="sxs-lookup"><span data-stu-id="01b6a-105">About the author</span></span>

![Ed Fisher 照片](../media/solutions-architecture-center/ed-fisher-networking.jpg) 

<span data-ttu-id="01b6a-107">我目前是南部地区的主要技术专家，主要负责安全与&合规性。</span><span class="sxs-lookup"><span data-stu-id="01b6a-107">I'm currently a Principal Technical Specialist in the South East region focusing on Security & Compliance.</span></span> <span data-ttu-id="01b6a-108">过去 10 年中，我与客户一起迁移到 Office 365。</span><span class="sxs-lookup"><span data-stu-id="01b6a-108">I've worked with customers moving to Office 365 for the past 10 years.</span></span> <span data-ttu-id="01b6a-109">我与一些小型商店合作过，其中一些位于政府机构和企业，拥有数百万用户分布于世界各地的用户，以及许多介于两者之间的其他客户，其中大多数拥有数万个用户、位于世界各地的多个位置、需要更高程度的安全性以及大量合规性要求。</span><span class="sxs-lookup"><span data-stu-id="01b6a-109">I’ve worked with smaller shops with a handful of locations to government agencies and enterprises with millions of users distributed around the world, and many other customers in between, with the majority having tens of thousands of users, multiple locations in various parts of the world, the need for a higher degree of security, and a multitude of compliance requirements.</span></span> <span data-ttu-id="01b6a-110">我帮助数百万企业和数百万用户安全移动到云。</span><span class="sxs-lookup"><span data-stu-id="01b6a-110">I've helped hundreds of enterprises and millions of users move to the cloud safely and securely.</span></span>

<span data-ttu-id="01b6a-111">过去 25 年的背景包括安全、基础结构和网络工程，并且之前曾有两个雇主在加入 Microsoft 之前已移动到 Office 365，因此我多次支持你，并且请记住这一点。</span><span class="sxs-lookup"><span data-stu-id="01b6a-111">With a background over the past 25 years that includes security, infrastructure, and network engineering, and having moved two of my previous employers to Office 365 before joining Microsoft, I’ve been on your side of the table plenty of times, and do remember what that’s like.</span></span> <span data-ttu-id="01b6a-112">虽然没有两个客户是相同的，但大多数客户都有类似的需求，在使用标准化服务（如任何 SaaS 或 PaaS 平台）时，最佳方法往往相同。</span><span class="sxs-lookup"><span data-stu-id="01b6a-112">While no two customers are ever the same, most have similar needs, and when consuming a standardized service such as any SaaS or PaaS platform, the best approaches tend to be the same.</span></span>

## <a name="its-not-the-networkits-how-youre-misusing-it"></a><span data-ttu-id="01b6a-113">这不是网络，而是你在使用它时 (错误) 错误！</span><span class="sxs-lookup"><span data-stu-id="01b6a-113">It’s not the network—it’s how you’re (mis)using it!</span></span>

<span data-ttu-id="01b6a-114">无论发生多少次，始终会向我说明创意安全团队和网络团队如何尝试了解他们应如何连接到 Microsoft 云服务。</span><span class="sxs-lookup"><span data-stu-id="01b6a-114">No matter how many times it happens, it never fails to amaze me how *creative* security teams and networking teams try to get with how they think they should connect to Microsoft cloud services.</span></span> <span data-ttu-id="01b6a-115">他们始终有一些安全策略、合规性标准或更好的方法坚持使用，而不会愿意就他们尝试完成的任务展开对话，或者他们这样做的方式更好、更简单、更经济且性能更佳。 </span><span class="sxs-lookup"><span data-stu-id="01b6a-115">There’s always some security policy, compliance standard, or better way they insist on using, without being willing to engage in a conversation about what it is they're trying to accomplish, or *how* they're better, easier, more cost-effective, and more performant ways of doing so.</span></span>

<span data-ttu-id="01b6a-116">当此类事件升级至我时，我通常愿意接受挑战，并让他们了解其方式和原因，并让他们到达所需的位置。</span><span class="sxs-lookup"><span data-stu-id="01b6a-116">When this sort of thing is escalated to me, I’m usually willing to take the challenge and walk them through the how's and the why's and get them to where they need to be.</span></span> <span data-ttu-id="01b6a-117">但是，如果我完全直白，我有时必须分享一下，有时我想让他们执行他们将要执行哪些任务，然后返回说，我告知你，当他们最终看到它不起作用时。</span><span class="sxs-lookup"><span data-stu-id="01b6a-117">But if I'm being completely frank, I have to share that sometimes I want to just let them do what they will, and come back to say I told you so when they finally concede it doesn’t work.</span></span> <span data-ttu-id="01b6a-118">我有时可能想要这样做，但 *不想这样做*。</span><span class="sxs-lookup"><span data-stu-id="01b6a-118">I may want to do that sometimes, but I *don’t*.</span></span> <span data-ttu-id="01b6a-119">我应尝试说明本文中将包含的所有内容。</span><span class="sxs-lookup"><span data-stu-id="01b6a-119">What I do is try to explain all of what I'm going to include in this post.</span></span> <span data-ttu-id="01b6a-120">无论你的角色如何，如果你的组织想要使用 Microsoft 云服务，那么以下内容可能有一些希望，可以帮助你实现此目标。</span><span class="sxs-lookup"><span data-stu-id="01b6a-120">Regardless of your role, if your organization wants to use Microsoft cloud services, there’s probably some wisdom in what follows that can help you out.</span></span>

## <a name="guiding-principles"></a><span data-ttu-id="01b6a-121">指导原则</span><span class="sxs-lookup"><span data-stu-id="01b6a-121">Guiding principles</span></span>

<span data-ttu-id="01b6a-122">让我们从我们在此处所执行事情的一些基础规则开始。</span><span class="sxs-lookup"><span data-stu-id="01b6a-122">Let’s start with some ground rules around what we’re doing here.</span></span> <span data-ttu-id="01b6a-123">我们讨论如何安全地连接到云服务，以确保最低复杂度和最佳性能，同时保证真实安全性。</span><span class="sxs-lookup"><span data-stu-id="01b6a-123">We are discussing how to securely connect to cloud services to ensure the minimum complexity, and the maximum performance, while maintaining real security.</span></span> <span data-ttu-id="01b6a-124">以下任何内容均不与上述任何内容相反，即使你或你的客户无法将你最喜爱的代理服务器用于所有内容。</span><span class="sxs-lookup"><span data-stu-id="01b6a-124">None of what follows is counter to any of that, even if you, or your customer, won’t get to use your favorite proxy server for everything.</span></span>

- <span data-ttu-id="01b6a-125">**仅仅因为可以，并不意味着** 你应该：或者从 一个 一千多米的 一位 Ian Malcolm 电影"...是的，是的，但你的安全团队对他们是否可以停止思考是否该停止思考非常有希望。"</span><span class="sxs-lookup"><span data-stu-id="01b6a-125">**Just because you can, doesn’t mean you should**: Or to paraphrase Dr. Ian Malcolm from the Jurassic Park movie “...Yeah, yeah, but your security team was so preoccupied with whether or not they could that they didn't stop to think if they should.”</span></span>
- <span data-ttu-id="01b6a-126">**安全性并不意味着复杂性：** 你并非因为花费更多资金、通过更多设备路由或单击更多按钮而更加安全。</span><span class="sxs-lookup"><span data-stu-id="01b6a-126">**Security does not mean complexity**: You are not more secure just because you spend more money, route through more devices, or click more buttons.</span></span>
- <span data-ttu-id="01b6a-127">**Office 365** 通过 Internet 访问：但这与 Office 365 是 Internet 不同。</span><span class="sxs-lookup"><span data-stu-id="01b6a-127">**Office 365 is accessed over the Internet**: But that’s not the same thing as Office 365 is the Internet.</span></span> <span data-ttu-id="01b6a-128">它是由 Microsoft 管理的 SaaS 服务，由你管理。</span><span class="sxs-lookup"><span data-stu-id="01b6a-128">It’s a SaaS service managed by Microsoft and administered by you.</span></span> <span data-ttu-id="01b6a-129">与在 Internet 上访问的网站不同，实际上你确实可以了解这些挑战，并可以应用符合策略和合规性标准所需的控制措施，只要了解在达到目标时，可能只需以不同方式执行它们。</span><span class="sxs-lookup"><span data-stu-id="01b6a-129">Unlike websites you visit on the Internet, you actually do get to peek behind the curtain, and can apply the controls you need to meet your policies and your compliance standards, as long as you understand that while you can meet your objectives, you may just have to do them in a different way.</span></span>
- <span data-ttu-id="01b6a-130">**断** 点很差，本地化后效果不错：每个人始终希望将所有用户的所有 Internet 流量都返回到一个中心点，通常这样他们就可以监视它并强制执行策略，但通常是因为这样做比在所有位置设置 Internet 访问要低，或者只是他们这样做。</span><span class="sxs-lookup"><span data-stu-id="01b6a-130">**Chokepoints are bad, localized breakouts are good**: Everybody always wants to backhaul all their Internet traffic for all their users to some central point, usually so they can monitor it and enforce policy, but often because it’s either cheaper than provisioning Internet access in all their locations, or it’s just how they do it.</span></span> <span data-ttu-id="01b6a-131">但是，这些点正是这样...路点数。</span><span class="sxs-lookup"><span data-stu-id="01b6a-131">But those chokepoints are exactly that…points where traffic chokes.</span></span> <span data-ttu-id="01b6a-132">阻止用户浏览 Instagram 或流式传输 cat 视频没有任何错误，但不要以相同方式处理任务关键型业务应用程序流量。</span><span class="sxs-lookup"><span data-stu-id="01b6a-132">There’s nothing wrong with preventing your users from browsing to Instagram or streaming cat videos, but don’t treat your mission-critical business application traffic the same way.</span></span>
- <span data-ttu-id="01b6a-133">如果 **DNS** 不满意，则一定不满意：最好的设计网络可能是由较差的 DNS 所攻击，无论是通过递归对世界上其他国家/地区的服务器的请求，还是使用 ISP 的 DNS 服务器或其他用于缓存 DNS 解析信息的公共 DNS 服务器。</span><span class="sxs-lookup"><span data-stu-id="01b6a-133">**If DNS ain’t happy, ain’t nothing happy**: The best designed network can be hamstrung by poor DNS, whether that is by recursing requests to servers in other areas of the world or using your ISP’s DNS servers or other public DNS servers that cache DNS resolution information.</span></span>
- <span data-ttu-id="01b6a-134">**正如你** 过去这样执行它一样，这并不意味着你现在应该这样做：技术会不断变化，并且 Office 365 也不例外。</span><span class="sxs-lookup"><span data-stu-id="01b6a-134">**Just because that’s how you used to do it, doesn’t mean that’s how you should do it now**: Technology changes constantly and Office 365 is no exception.</span></span> <span data-ttu-id="01b6a-135">应用为本地服务或控制 Web 部件而开发并部署的安全措施不会提供相同级别的安全保证，并且会对性能产生显著的负面影响。</span><span class="sxs-lookup"><span data-stu-id="01b6a-135">Applying security measures that were developed and deployed for on-premises services or to control web surfing aren’t going to provide the same level of security assurance, and can have a significant negative impact on performance.</span></span>
- <span data-ttu-id="01b6a-136">Office 365 是专为通过 Internet 访问而构建的：简而言之，就是为了访问 Office **365。**</span><span class="sxs-lookup"><span data-stu-id="01b6a-136">**Office 365 was built to be accessed over the Internet**: That’s it in a nutshell.</span></span> <span data-ttu-id="01b6a-137">无论你的用户和边缘之间要做什么，流量在离开网络之后、进入我们的网络之前仍将通过 Internet。</span><span class="sxs-lookup"><span data-stu-id="01b6a-137">No matter what you want to do between your users and your edge, the traffic still goes over the Internet once it leaves your network and before it gets onto ours.</span></span> <span data-ttu-id="01b6a-138">即使你使用 Azure ExpressRoute 将某些延迟敏感流量直接从网络路由到我们的网络，也绝对需要 Internet 连接。</span><span class="sxs-lookup"><span data-stu-id="01b6a-138">Even if you are using Azure ExpressRoute to route some latency sensitive traffic from your network directly to ours, Internet connectivity is absolutely required.</span></span> <span data-ttu-id="01b6a-139">接受它。</span><span class="sxs-lookup"><span data-stu-id="01b6a-139">Accept it.</span></span> <span data-ttu-id="01b6a-140">不要过度认为它。</span><span class="sxs-lookup"><span data-stu-id="01b6a-140">Don’t overthink it.</span></span>

## <a name="where-bad-choices-are-often-made"></a><span data-ttu-id="01b6a-141">经常做出错误选择的地方</span><span class="sxs-lookup"><span data-stu-id="01b6a-141">Where bad choices are often made</span></span>

<span data-ttu-id="01b6a-142">虽然有很多地方在安全名称中做出错误决策，但这些都是我经常与客户接触的地方。</span><span class="sxs-lookup"><span data-stu-id="01b6a-142">While there are plenty of places where bad decisions are made in the name of security, these are the ones I encounter most often with customers.</span></span> <span data-ttu-id="01b6a-143">许多客户对话同时涉及所有这些内容。</span><span class="sxs-lookup"><span data-stu-id="01b6a-143">Many customer conversations involve all of these at once.</span></span>

### <a name="insufficient-resources-at-the-edge"></a><span data-ttu-id="01b6a-144">边缘资源不足</span><span class="sxs-lookup"><span data-stu-id="01b6a-144">Insufficient resources at the edge</span></span>

<span data-ttu-id="01b6a-145">非常少的客户正在部署绿色域环境，他们拥有有关其用户工作方式和 Internet 出口方式的数年经验。</span><span class="sxs-lookup"><span data-stu-id="01b6a-145">Very few customers are deploying greenfield environments, and they have years of experience with how their users work and what their Internet egress is like.</span></span> <span data-ttu-id="01b6a-146">无论客户是具有代理服务器，还是允许直接访问和仅 NAT 出站流量，他们一直在执行此操作多年，他们不考虑在将传统内部应用程序移到云时，他们开始通过边缘访问会多多少。</span><span class="sxs-lookup"><span data-stu-id="01b6a-146">Whether customers have proxy servers or allow direct access and simply NAT outbound traffic, they’ve been doing it for years and don’t consider just how much more they are going to start pumping through their edge as they move traditionally internal applications out to the cloud.</span></span>

<span data-ttu-id="01b6a-147">带宽始终是一个问题，但 NAT 设备可能没有足够的能力来处理增加的负载，并且可能会提前关闭连接以释放资源。</span><span class="sxs-lookup"><span data-stu-id="01b6a-147">Bandwidth is always a concern, but NAT devices may not have enough horsepower to handle the increased load and may start prematurely closing connections to free up resources.</span></span> <span data-ttu-id="01b6a-148">大多数连接到 Office 365 的客户端软件需要永久连接，完全利用 Office 365 的用户可能拥有 32 个或多个并发连接。</span><span class="sxs-lookup"><span data-stu-id="01b6a-148">Most of the client software that connects to Office 365 expects persistent connections and a user fully utilizing Office 365 may have 32 or more concurrent connections.</span></span> <span data-ttu-id="01b6a-149">如果 NAT 设备提前丢弃它们，这些应用可能在尝试使用不再存在的连接时无响应。</span><span class="sxs-lookup"><span data-stu-id="01b6a-149">If the NAT device is dropping them prematurely, those apps may become unresponsive as they try to use the connections that are no longer there.</span></span> <span data-ttu-id="01b6a-150">当他们放弃并尝试建立新连接时，他们会为网络齿轮增加更多的负载。</span><span class="sxs-lookup"><span data-stu-id="01b6a-150">When they give up and try to establish new connections, they put even more load on your network gear.</span></span>

### <a name="localized-breakout"></a><span data-ttu-id="01b6a-151">本地化后</span><span class="sxs-lookup"><span data-stu-id="01b6a-151">Localized breakout</span></span>

<span data-ttu-id="01b6a-152">此列表中的其他所有内容都归为一件事，即尽快离开网络和我们的网络。</span><span class="sxs-lookup"><span data-stu-id="01b6a-152">Everything else in this list comes down to one thing—getting off your network and onto ours as quickly as possible.</span></span> <span data-ttu-id="01b6a-153">将用户的流量返回到中心出口点，尤其是在该出口点位于用户位于另一个区域时，这会造成不必要的延迟，并影响客户端体验和下载速度。</span><span class="sxs-lookup"><span data-stu-id="01b6a-153">Backhauling your users’ traffic to a central egress point, especially when that egress point is in another region than your users are in, introduces unnecessary latency and impacts both the client experience and download speeds.</span></span> <span data-ttu-id="01b6a-154">Microsoft 具有全球的接入点，用于我们所有服务的前端，并且几乎与每个主要 ISP 建立对等，因此将用户的流量路由到本地可确保它以最小延迟快速进入我们的网络。</span><span class="sxs-lookup"><span data-stu-id="01b6a-154">Microsoft has points of presence throughout the world with front ends for all our services and peering established with practically every major ISP, so routing your users’ traffic out *locally* ensures it gets into our network quickly with minimum latency.</span></span>

### <a name="dns-resolution-traffic-should-follow-the-internet-egress-path"></a><span data-ttu-id="01b6a-155">DNS 解析流量应遵循 Internet 出口路径</span><span class="sxs-lookup"><span data-stu-id="01b6a-155">DNS resolution traffic should follow the Internet egress path</span></span>

<span data-ttu-id="01b6a-156">当然，客户端需要使用 DNS 来查找任何终结点。</span><span class="sxs-lookup"><span data-stu-id="01b6a-156">Of course, for a client to find any endpoint, it needs to use DNS.</span></span> <span data-ttu-id="01b6a-157">Microsoft 的 DNS 服务器评估 DNS 请求的来源，以确保我们返回的响应（以 Internet 术语而言）最接近请求来源。</span><span class="sxs-lookup"><span data-stu-id="01b6a-157">Microsoft’s DNS servers evaluate the source of DNS requests to ensure we return the response that is, in Internet terms, closest to the source of the request.</span></span> <span data-ttu-id="01b6a-158">请确保你的 DNS 已配置，以便名称解析请求与用户的流量进入相同的路径，以免你向它们提供本地出口，但提供到另一个地区的终结点。</span><span class="sxs-lookup"><span data-stu-id="01b6a-158">Make sure your DNS is configured so that name resolution requests go out the same path as your users’ traffic, lest you give them local egress but to an endpoint in another region.</span></span> <span data-ttu-id="01b6a-159">这意味着允许本地 DNS 服务器"转到根"，而不是转发到远程数据中心的 DNS 服务器。</span><span class="sxs-lookup"><span data-stu-id="01b6a-159">That means letting local DNS servers “go to root” rather than forwarding to DNS servers in remote data centers.</span></span> <span data-ttu-id="01b6a-160">并留意公用和专用 DNS 服务，这些服务可能会缓存来自世界上一部分的结果，并针对来自世界其他地方的请求提供服务。</span><span class="sxs-lookup"><span data-stu-id="01b6a-160">And watch out for public and private DNS services, which may cache results from one part of the world and serve them to requests from other parts of the world.</span></span>

### <a name="to-proxy-or-not-to-proxy-that-is-the-question"></a><span data-ttu-id="01b6a-161">要代理还是不代理，这就是问题</span><span class="sxs-lookup"><span data-stu-id="01b6a-161">To proxy or not to proxy, that is the question</span></span>

<span data-ttu-id="01b6a-162">首先要考虑的一件事是，是否将用户的连接代理到 Office 365。</span><span class="sxs-lookup"><span data-stu-id="01b6a-162">One of the first things to consider is whether to proxy users’ connections to Office 365.</span></span> <span data-ttu-id="01b6a-163">这很简单;不代理。</span><span class="sxs-lookup"><span data-stu-id="01b6a-163">That one’s easy; do not proxy.</span></span> <span data-ttu-id="01b6a-164">Office 365 通过 Internet 访问，但它不是 Internet。</span><span class="sxs-lookup"><span data-stu-id="01b6a-164">Office 365 is accessed over the Internet, but it is not THE Internet.</span></span> <span data-ttu-id="01b6a-165">它是核心服务的扩展，应作为此类服务处理。</span><span class="sxs-lookup"><span data-stu-id="01b6a-165">It’s an extension of your core services and should be treated as such.</span></span> <span data-ttu-id="01b6a-166">您可能希望代理执行的任何操作（如 DLP、反恶意软件或内容检查）已在服务中可用，并且可大规模使用，而无需破解 TLS 加密的连接。</span><span class="sxs-lookup"><span data-stu-id="01b6a-166">Anything you might want a proxy to do, such as DLP or antimalware or content inspection, is already available to you in the service, and can be used at scale and without needing to crack TLS-encrypted connections.</span></span> <span data-ttu-id="01b6a-167">但是，如果确实要代理无法控制的流量，请留意我们的指南和 中的 [https://aka.ms/pnc](../enterprise/microsoft-365-network-connectivity-principles.md) 流量类别 [https://aka.ms/ipaddrs](../enterprise/urls-and-ip-address-ranges.md) 。</span><span class="sxs-lookup"><span data-stu-id="01b6a-167">But if you really want to proxy traffic that you cannot otherwise control, pay attention to our guidance at [https://aka.ms/pnc](../enterprise/microsoft-365-network-connectivity-principles.md) and the categories of traffic at [https://aka.ms/ipaddrs](../enterprise/urls-and-ip-address-ranges.md).</span></span> <span data-ttu-id="01b6a-168">我们有三类 Office 365 流量。</span><span class="sxs-lookup"><span data-stu-id="01b6a-168">We have three categories of traffic for Office 365.</span></span> <span data-ttu-id="01b6a-169">"优化"和"允许"确实应该直接进行，并绕过代理。</span><span class="sxs-lookup"><span data-stu-id="01b6a-169">Optimize and Allow really should go direct and bypass your proxy.</span></span> <span data-ttu-id="01b6a-170">可以代理默认值。</span><span class="sxs-lookup"><span data-stu-id="01b6a-170">Default can be proxied.</span></span> <span data-ttu-id="01b6a-171">详细信息请参阅这些文档...读取它们。</span><span class="sxs-lookup"><span data-stu-id="01b6a-171">The details are in those docs...read them.</span></span>

<span data-ttu-id="01b6a-172">当客户实际查看自己正在执行哪些操作时，坚持使用代理的客户会意识到，当客户端向代理发送 HTTP CONNECT 请求时，代理现在只是一个昂贵的额外路由器。</span><span class="sxs-lookup"><span data-stu-id="01b6a-172">Most customers who insist on using a proxy, when they actually look at what they are doing, come to realize that when the client makes an HTTP CONNECT request to the proxy, the proxy is now just an expensive extra router.</span></span> <span data-ttu-id="01b6a-173">使用的协议（如 MAPI 和 RTC）甚至不是 Web 代理理解的协议，因此即使使用 TLS 破解，你并没有真正获得任何额外的安全性。</span><span class="sxs-lookup"><span data-stu-id="01b6a-173">The protocols in use such as MAPI and RTC are not even protocols that web proxies understand, so even with TLS cracking you’re not really getting any extra security.</span></span> <span data-ttu-id="01b6a-174">*您* 正获得额外的延迟。</span><span class="sxs-lookup"><span data-stu-id="01b6a-174">You *are* getting extra latency.</span></span> <span data-ttu-id="01b6a-175">有关详细信息 [https://aka.ms/pnc](../enterprise/microsoft-365-network-connectivity-principles.md) ，请参阅 Microsoft 365 流量的优化、允许和默认类别。</span><span class="sxs-lookup"><span data-stu-id="01b6a-175">See [https://aka.ms/pnc](../enterprise/microsoft-365-network-connectivity-principles.md) for more on this, including the Optimize, Allow, and Default categories for Microsoft 365 traffic.</span></span>

<span data-ttu-id="01b6a-176">最后，考虑对代理的总体影响及其相应的响应来处理该影响。</span><span class="sxs-lookup"><span data-stu-id="01b6a-176">Finally, consider the overall impact to the proxy and its corresponding response to deal with that impact.</span></span> <span data-ttu-id="01b6a-177">随着通过代理建立的连接越来越多，它可能会降低 TCP 比例系数，这样它就不必缓冲太多流量。</span><span class="sxs-lookup"><span data-stu-id="01b6a-177">As more and more connections are being made through the proxy, it may decrease the TCP Scale Factor so that it doesn’t have to buffer so much traffic.</span></span> <span data-ttu-id="01b6a-178">我所见，他们的代理超载到他们使用的是比例系数 0 的客户。</span><span class="sxs-lookup"><span data-stu-id="01b6a-178">I’ve seen customers where their proxies were so overloaded that they were using a Scale Factor of 0.</span></span> <span data-ttu-id="01b6a-179">由于比例系数是指数值，并且我们希望使用 8，因此每次降低比例系数值会对吞吐量产生巨大负面影响。</span><span class="sxs-lookup"><span data-stu-id="01b6a-179">Since Scale Factor is an exponential value and we like to use 8, each reduction in the Scale Factor value is a huge negative impact to throughput.</span></span>

<span data-ttu-id="01b6a-180">TLS 检查意味着安全性！</span><span class="sxs-lookup"><span data-stu-id="01b6a-180">TLS Inspection means SECURITY!</span></span> <span data-ttu-id="01b6a-181">但其实不是！</span><span class="sxs-lookup"><span data-stu-id="01b6a-181">But not really!</span></span> <span data-ttu-id="01b6a-182">许多具有代理的客户希望使用它们检查所有流量，这意味着 TLS"中断并检查"。</span><span class="sxs-lookup"><span data-stu-id="01b6a-182">Many customers with proxies want to use them to inspect all traffic, and that means TLS “break and inspect.”</span></span> <span data-ttu-id="01b6a-183">当您对通过 HTTPS (访问的网站执行上述操作时) 您的代理可能需要在几百毫秒内对 10 甚至 20 个并发流执行这些操作。</span><span class="sxs-lookup"><span data-stu-id="01b6a-183">When you do that for a website accessed over HTTPS (privacy concerns notwithstanding) your proxy may have to do that for 10 or even 20 concurrent streams for a few hundred milliseconds.</span></span> <span data-ttu-id="01b6a-184">如果下载量很大或视频可能涉及，则其中一个或多个连接可能会持续更长时间，但从总体上说，这些连接中的大多数连接会非常快速地建立、转移和关闭。</span><span class="sxs-lookup"><span data-stu-id="01b6a-184">If there’s a large download or maybe a video involved, one or more of those connections may last much longer, but on the whole, most of those connections establish, transfer, and close very quickly.</span></span> <span data-ttu-id="01b6a-185">执行中断和检查意味着代理必须执行双倍工作。</span><span class="sxs-lookup"><span data-stu-id="01b6a-185">Doing break and inspect means the proxy must do double the work.</span></span> <span data-ttu-id="01b6a-186">对于从客户端到代理的每个连接，代理还必须与终结点建立单独的连接。</span><span class="sxs-lookup"><span data-stu-id="01b6a-186">For each connection from the client to the proxy, the proxy must also make a separate connection back to the endpoint.</span></span> <span data-ttu-id="01b6a-187">因此，1 变为 2，2 变为 4，32 变为 64...查看我在哪里？</span><span class="sxs-lookup"><span data-stu-id="01b6a-187">So, 1 becomes 2, 2 becomes 4, 32 becomes 64...see where I am going?</span></span> <span data-ttu-id="01b6a-188">您可能调整代理解决方案的大小并适合典型的 Web 浏览器，但当您尝试对与 Office 365 的客户端连接执行相同的操作时，并发长期连接的数量可能大于您调整大小的大小。</span><span class="sxs-lookup"><span data-stu-id="01b6a-188">You probably sized your proxy solution just fine for typical web surfing, but when you try to do the same thing for client connections to Office 365, the number of concurrent, long-lived connections may be orders of magnitude greater than what you sized for.</span></span>

### <a name="streaming-isnt-important-except-that-it-is"></a><span data-ttu-id="01b6a-189">流式处理不是很重要，只是 *它是*</span><span class="sxs-lookup"><span data-stu-id="01b6a-189">Streaming isn’t important, except that it *is*</span></span>

<span data-ttu-id="01b6a-190">Office 365 中唯一使用 UDP 的服务是 Skype (即将在 Microsoft Teams) 停用。</span><span class="sxs-lookup"><span data-stu-id="01b6a-190">The only services in Office 365 that use UDP are Skype (soon to be retired) and Microsoft Teams.</span></span> <span data-ttu-id="01b6a-191">Teams 使用 UDP 流式传输流量，包括音频、视频和演示文稿共享。</span><span class="sxs-lookup"><span data-stu-id="01b6a-191">Teams uses UDP for streaming traffic including audio, video, and presentation sharing.</span></span> <span data-ttu-id="01b6a-192">流式传输流量是实时的，例如当你要召开具有语音、视频的联机会议，以及演示平台或执行演示时。</span><span class="sxs-lookup"><span data-stu-id="01b6a-192">Streaming traffic is live, such as when you're having an online meeting with voice, video, and presenting decks or performing demos.</span></span> <span data-ttu-id="01b6a-193">它们使用 UDP 是因为，如果数据包被丢弃或顺序中断，用户几乎无法注意到数据包，并且流可以继续运行。</span><span class="sxs-lookup"><span data-stu-id="01b6a-193">These use UDP because if packets are dropped, or arrive out of order, it’s practically unnoticeable by the user and the stream can just keep going.</span></span>

<span data-ttu-id="01b6a-194">如果不允许从客户端到服务的出站 UDP 流量，它们可以回退到使用 TCP。</span><span class="sxs-lookup"><span data-stu-id="01b6a-194">When you don’t permit outbound UDP traffic from clients to the service, they can fall back to using TCP.</span></span> <span data-ttu-id="01b6a-195">但是，如果丢弃了 TCP数据包，则一切将停止，直到 RTO (重新传输超时) 并且可以重新传输丢失的数据包。</span><span class="sxs-lookup"><span data-stu-id="01b6a-195">But if a TCP packet is dropped, *everything stops* until the Retransmission Timeout (RTO) expires and the missing packet can be retransmitted.</span></span> <span data-ttu-id="01b6a-196">如果数据包未按序到达，则所有内容将停止，直到其他数据包到达，并可以按序重新组合。</span><span class="sxs-lookup"><span data-stu-id="01b6a-196">If a packet arrives out of order, everything stops until the other packets arrive and can be reassembled in order.</span></span> <span data-ttu-id="01b6a-197">这两种操作都会导致音频问题 (最大会议室？) 以及 (单击了某些内容...有一) ，会导致性能不佳和用户体验不佳。</span><span class="sxs-lookup"><span data-stu-id="01b6a-197">Both lead to perceptible glitches in the audio (remember Max Headroom?) and video (did you click something...oh, there it is) and lead to poor performance and a bad user experience.</span></span> <span data-ttu-id="01b6a-198">请记住我上面关于代理的哪些内容？</span><span class="sxs-lookup"><span data-stu-id="01b6a-198">And remember what I put up above about proxies?</span></span> <span data-ttu-id="01b6a-199">当你强制 Teams 客户端使用代理时，你强制它使用 TCP。</span><span class="sxs-lookup"><span data-stu-id="01b6a-199">When you force a Teams client to use a proxy, you force it to use TCP.</span></span> <span data-ttu-id="01b6a-200">因此，现在对性能造成负面影响两次。</span><span class="sxs-lookup"><span data-stu-id="01b6a-200">So now you’re causing negative performance impacts twice.</span></span>

### <a name="split-tunneling-may-seem-scary"></a><span data-ttu-id="01b6a-201">拆分隧道可能看起来不令人难看</span><span class="sxs-lookup"><span data-stu-id="01b6a-201">Split tunneling may seem scary</span></span>

<span data-ttu-id="01b6a-202">但它不是。</span><span class="sxs-lookup"><span data-stu-id="01b6a-202">But it isn’t.</span></span> <span data-ttu-id="01b6a-203">所有与 Office 365 的连接都通过 TLS 进行。</span><span class="sxs-lookup"><span data-stu-id="01b6a-203">All connections to Office 365 are over TLS.</span></span> <span data-ttu-id="01b6a-204">我们已提供 TLS 1.2 相当长的一段时间，并且很快将禁用较旧版本，因为旧版客户端仍使用它们，这是一种风险。</span><span class="sxs-lookup"><span data-stu-id="01b6a-204">We have been offering TLS 1.2 for quite a while now and will be disabling older versions soon because legacy clients still use them and that’s a risk.</span></span>

<span data-ttu-id="01b6a-205">强制 TLS 连接（或其中 32 个）先通过 VPN，然后再转到服务，这不会添加安全性。</span><span class="sxs-lookup"><span data-stu-id="01b6a-205">Forcing a TLS connection, or 32 of them, to go over a VPN before they then go to the service doesn't add security.</span></span> <span data-ttu-id="01b6a-206">它会增加延迟并降低总体吞吐量。</span><span class="sxs-lookup"><span data-stu-id="01b6a-206">It does add latency and reduces overall throughput.</span></span> <span data-ttu-id="01b6a-207">在某些 VPN 解决方案中，它甚至会强制 UDP 通过 TCP 隧道，这同样会对流式传输产生非常负面影响。</span><span class="sxs-lookup"><span data-stu-id="01b6a-207">In some VPN solutions, it even forces UDP to tunnel through TCP, which again will have a very negative impact on streaming traffic.</span></span> <span data-ttu-id="01b6a-208">而且，除非你要执行 TLS 检查，否则没有缺点，所有缺点都一样。</span><span class="sxs-lookup"><span data-stu-id="01b6a-208">And, unless you are doing TLS inspection, there's no upside, all downside.</span></span> <span data-ttu-id="01b6a-209">客户之间的一个非常常见的主题（现在大多数员工都是远程工作者）的一个常见主题是，他们看到通过使所有用户使用 VPN 进行连接（而不是配置拆分隧道以访问"优化"类别的 [Office 365](../enterprise/microsoft-365-network-connectivity-principles.md#new-office-365-endpoint-categories)终结点）的显著带宽和性能影响。</span><span class="sxs-lookup"><span data-stu-id="01b6a-209">A very common theme among customers, now that most of their workforce is remote, is that they're seeing significant bandwidth and performance impacts from making all their users connect using a VPN, instead of configuring split tunneling for access to [Optimize category Office 365 endpoints](../enterprise/microsoft-365-network-connectivity-principles.md#new-office-365-endpoint-categories).</span></span>

<span data-ttu-id="01b6a-210">执行拆分隧道是一个简单的解决方法，你应该这样做。</span><span class="sxs-lookup"><span data-stu-id="01b6a-210">It’s an easy fix to do split tunneling and it’s one you should do.</span></span> <span data-ttu-id="01b6a-211">有关详细信息，请确保查看使用 VPN 拆分隧道为远程用户 [优化 Office 365 连接](../enterprise/microsoft-365-vpn-split-tunnel.md)。</span><span class="sxs-lookup"><span data-stu-id="01b6a-211">For more, make sure you review [Optimize Office 365 connectivity for remote users using VPN split tunneling](../enterprise/microsoft-365-vpn-split-tunnel.md).</span></span>

## <a name="the-sins-of-the-past"></a><span data-ttu-id="01b6a-212">过去的犯罪</span><span class="sxs-lookup"><span data-stu-id="01b6a-212">The sins of the past</span></span>

<span data-ttu-id="01b6a-213">很多时候，错误选择的原因包括： (1) 不知道服务的工作方式、 (2) 尝试遵守采用云之前编写的公司策略，以及 (3) 安全团队，这些团队可能无法轻易确信有多种方法可以实现目标。</span><span class="sxs-lookup"><span data-stu-id="01b6a-213">Many times, the reason bad choices are made comes from a combination of (1) not knowing how the service works, (2) trying to adhere to company policies that were written before adopting the cloud, and (3) security teams who may not be easily convinced that there’s more than one way to accomplish their goals.</span></span> <span data-ttu-id="01b6a-214">希望上述和下面的链接将有助于第一个操作。</span><span class="sxs-lookup"><span data-stu-id="01b6a-214">Hopefully the above, and the links below, will help with the first.</span></span> <span data-ttu-id="01b6a-215">可能需要管理层的支持才能通过第二项。</span><span class="sxs-lookup"><span data-stu-id="01b6a-215">Executive sponsorship may be required to get past the second.</span></span> <span data-ttu-id="01b6a-216">实现安全策略的目标（而不是其方法）有助于实现第三个目标。</span><span class="sxs-lookup"><span data-stu-id="01b6a-216">Addressing the security policies’ goals, rather than their methods, helps with the third.</span></span> <span data-ttu-id="01b6a-217">从条件访问到内容审核、DLP 到信息保护、终结点验证到零日威胁- 合理安全策略可能达到的任何最终目标都可以通过 Office 365 中提供的内容实现，而无需依赖本地网络设备、强制 VPN 隧道和 TLS 中断和检查。</span><span class="sxs-lookup"><span data-stu-id="01b6a-217">From conditional access to content moderation, DLP to information protection, endpoint validation to zero-day threats—any end goal a reasonable security policy may have can be accomplished with what is available in Office 365, and without any dependency upon on-premises network gear, forced VPN tunnels, and TLS break and inspect.</span></span>

<span data-ttu-id="01b6a-218">其他时候，在组织开始移动到云之前调整大小并购买的硬件无法向上扩展以处理新的流量模式和负载。</span><span class="sxs-lookup"><span data-stu-id="01b6a-218">Other times, hardware that was sized and purchased before the organization started to move to the cloud simply cannot be scaled up to handle the new traffic patterns and loads.</span></span> <span data-ttu-id="01b6a-219">如果确实必须通过单个出口点路由所有流量，并/或代理它，请准备好相应地升级网络设备和带宽。</span><span class="sxs-lookup"><span data-stu-id="01b6a-219">If you truly must route all traffic through a single egress point, and/or proxy it, be prepared to upgrade network equipment and bandwidth accordingly.</span></span> <span data-ttu-id="01b6a-220">请仔细监视这两者上的利用率，因为随着更多用户上网，体验不会下降。</span><span class="sxs-lookup"><span data-stu-id="01b6a-220">Carefully monitor utilization on both, as the experience won’t diminish slowly as more users onboard.</span></span> <span data-ttu-id="01b6a-221">一切正常，直到达到提示点，然后每个人都受到影响。</span><span class="sxs-lookup"><span data-stu-id="01b6a-221">Everything will be fine until the tipping point is reached, then everyone suffers.</span></span>

## <a name="exceptions-to-the-rules"></a><span data-ttu-id="01b6a-222">规则例外</span><span class="sxs-lookup"><span data-stu-id="01b6a-222">Exceptions to the rules</span></span>

<span data-ttu-id="01b6a-223">如果你的组织需要 [租户限制](/azure/active-directory/manage-apps/tenant-restrictions)，你将需要使用具有 TLS 中断和检查的代理来强制一些流量通过代理，但你无需强制所有流量通过它。</span><span class="sxs-lookup"><span data-stu-id="01b6a-223">If your organization requires [tenant restrictions](/azure/active-directory/manage-apps/tenant-restrictions), you’ll need to use a proxy with TLS break and inspect to  force some traffic through the proxy, but you don’t have to force all traffic through it.</span></span>  <span data-ttu-id="01b6a-224">这不是全部或全无的主张，因此请注意需要由代理修改哪些方面。</span><span class="sxs-lookup"><span data-stu-id="01b6a-224">It’s not an all or nothing proposition, so pay attention to what does need to be modified by the proxy.</span></span>

<span data-ttu-id="01b6a-225">如果你打算允许拆分隧道，但也对常规 Web 流量使用代理，请确保 PAC 文件定义必须直接传输的内容以及如何为通过 VPN 隧道的内容定义有趣的流量。</span><span class="sxs-lookup"><span data-stu-id="01b6a-225">If you're going to permit split tunneling but also use a proxy for general web traffic, make sure your PAC file defines what must go direct as well as how you define interesting traffic for what goes through the VPN tunnel.</span></span> <span data-ttu-id="01b6a-226">我们提供了示例 PAC [https://aka.ms/ipaddrs](../enterprise/urls-and-ip-address-ranges.md) 文件，这样更易于管理。</span><span class="sxs-lookup"><span data-stu-id="01b6a-226">We offer sample PAC files at [https://aka.ms/ipaddrs](../enterprise/urls-and-ip-address-ranges.md) that will make this easier to manage.</span></span>

## <a name="conclusion"></a><span data-ttu-id="01b6a-227">总结</span><span class="sxs-lookup"><span data-stu-id="01b6a-227">Conclusion</span></span>

<span data-ttu-id="01b6a-228">成千上万个组织（包括几乎所有"世界 500 强"组织）每天使用 Office 365 执行其任务关键功能。</span><span class="sxs-lookup"><span data-stu-id="01b6a-228">Tens of thousands of organizations, including almost all the Fortune 500, use Office 365 everyday for their mission critical functions.</span></span> <span data-ttu-id="01b6a-229">它们可安全执行，并且通过 Internet 执行。</span><span class="sxs-lookup"><span data-stu-id="01b6a-229">They do so securely, and they do so over the Internet.</span></span>

<span data-ttu-id="01b6a-230">无论你实现什么安全目标，都可以通过一些方法实现这些目标，而不需要 VPN 连接、代理服务器、TLS 中断和检查或集中式 Internet 出口，以便尽快将用户的流量从网络和我们的网络传输至我们，无论网络是公司总部还是远程办公室，都可以提供最佳性能或在家工作的用户。</span><span class="sxs-lookup"><span data-stu-id="01b6a-230">No matter what security goals you have in play, there are ways to accomplish them that don’t require VPN connections, proxy servers, TLS break and inspect, or centralized Internet egress to get your users’ traffic off your network and on to ours as quickly as you can, which provides the best performance, whether your network is the company headquarters, a remote office, or that user working at home.</span></span> <span data-ttu-id="01b6a-231">我们的指南基于如何构建 Office 365 服务并确保安全且性能丰富的用户体验。</span><span class="sxs-lookup"><span data-stu-id="01b6a-231">Our guidance is based on how the Office 365 services are built and to ensure a secure and performant user experience.</span></span>

## <a name="further-reading"></a><span data-ttu-id="01b6a-232">进一步阅读</span><span class="sxs-lookup"><span data-stu-id="01b6a-232">Further reading</span></span>

[<span data-ttu-id="01b6a-233">Office 365 网络连接原则</span><span class="sxs-lookup"><span data-stu-id="01b6a-233">The Office 365 Network Connectivity Principles</span></span>](../enterprise/microsoft-365-network-connectivity-principles.md)

[<span data-ttu-id="01b6a-234">Office 365 URL 和 IP 地址范围</span><span class="sxs-lookup"><span data-stu-id="01b6a-234">Office 365 URLs and IP address ranges</span></span>](../enterprise/urls-and-ip-address-ranges.md)

[<span data-ttu-id="01b6a-235">管理 Office 365 终结点</span><span class="sxs-lookup"><span data-stu-id="01b6a-235">Managing Office 365 endpoints</span></span>](../enterprise/managing-office-365-endpoints.md)

[<span data-ttu-id="01b6a-236">Office 365 IP 地址和 URL Web 服务</span><span class="sxs-lookup"><span data-stu-id="01b6a-236">Office 365 IP Address and URL Web service</span></span>](../enterprise/microsoft-365-ip-web-service.md)

[<span data-ttu-id="01b6a-237">评估 Office 365 网络连接</span><span class="sxs-lookup"><span data-stu-id="01b6a-237">Assessing Office 365 network connectivity</span></span>](../enterprise/assessing-network-connectivity.md)

[<span data-ttu-id="01b6a-238">Office 365 网络和性能优化</span><span class="sxs-lookup"><span data-stu-id="01b6a-238">Office 365 network and performance tuning</span></span>](../enterprise/network-planning-and-performance.md)

[<span data-ttu-id="01b6a-239">评估 Office 365 网络连接</span><span class="sxs-lookup"><span data-stu-id="01b6a-239">Assessing Office 365 network connectivity</span></span>](../enterprise/assessing-network-connectivity.md)

[<span data-ttu-id="01b6a-240">使用基线和性能历史记录优化 Office 365 性能</span><span class="sxs-lookup"><span data-stu-id="01b6a-240">Office 365 performance tuning using baselines and performance history</span></span>](../enterprise/performance-tuning-using-baselines-and-history.md)

[<span data-ttu-id="01b6a-241">Office 365 性能疑难解答计划</span><span class="sxs-lookup"><span data-stu-id="01b6a-241">Performance troubleshooting plan for Office 365</span></span>](../enterprise/performance-troubleshooting-plan.md)

[<span data-ttu-id="01b6a-242">内容分发网络</span><span class="sxs-lookup"><span data-stu-id="01b6a-242">Content Delivery Networks</span></span>](../enterprise/content-delivery-networks.md)

[<span data-ttu-id="01b6a-243">Microsoft 365 连接测试</span><span class="sxs-lookup"><span data-stu-id="01b6a-243">Microsoft 365 connectivity test</span></span>](https://connectivity.office.com/)

[<span data-ttu-id="01b6a-244">Microsoft 如何构建其快速可靠的全球网络</span><span class="sxs-lookup"><span data-stu-id="01b6a-244">How Microsoft builds its fast and reliable global network</span></span>](https://azure.microsoft.com/blog/how-microsoft-builds-its-fast-and-reliable-global-network/)

[<span data-ttu-id="01b6a-245">Office 365 网络工作博客</span><span class="sxs-lookup"><span data-stu-id="01b6a-245">Office 365 Networking blog</span></span>](https://techcommunity.microsoft.com/t5/office-365-networking/bd-p/Office365Networking)

[<span data-ttu-id="01b6a-246">使用 VPN 拆分隧道的远程用户的 Office 365 连接</span><span class="sxs-lookup"><span data-stu-id="01b6a-246">Office 365 connectivity for remote users using VPN split tunneling</span></span>](../enterprise/microsoft-365-vpn-split-tunnel.md)